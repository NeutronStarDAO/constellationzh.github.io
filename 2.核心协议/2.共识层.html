<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>共识层 - 互联网计算机漫游指南</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The constellation book for you.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.png">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/style.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="../index.html"><strong aria-hidden="true">1.</strong> 互联网计算机漫游指南</a></li><li class="chapter-item affix "><li class="part-title">去中心化之旅</li><li class="chapter-item "><a href="../0.去中心化之旅/造梦家的冒险之旅.html"><strong aria-hidden="true">2.</strong> 造梦家的冒险之旅</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../0.去中心化之旅/未来已来.html"><strong aria-hidden="true">2.1.</strong> 未来已来</a></li><li class="chapter-item "><a href="../0.去中心化之旅/加密朋克的那些事.html"><strong aria-hidden="true">2.2.</strong> 加密朋克的那些事</a></li><li class="chapter-item "><a href="../0.去中心化之旅/区块链是啥？.html"><strong aria-hidden="true">2.3.</strong> 区块链是啥？</a></li><li class="chapter-item "><a href="../0.去中心化之旅/什么是以太坊？.html"><strong aria-hidden="true">2.4.</strong> 什么是以太坊？</a></li><li class="chapter-item "><a href="../0.去中心化之旅/我的网络隐私呢？.html"><strong aria-hidden="true">2.5.</strong> 我的网络隐私呢？</a></li><li class="chapter-item "><a href="../0.去中心化之旅/比特币.html"><strong aria-hidden="true">2.6.</strong> 比特币</a></li></ol></li><li class="chapter-item "><li class="part-title">了解IC</li><li class="chapter-item "><a href="../1.了解IC/1.了解IC.html"><strong aria-hidden="true">3.</strong> 了解IC</a></li><li class="chapter-item affix "><li class="part-title">核心协议</li><li class="chapter-item "><a href="../2.核心协议/1.P2P层.html"><strong aria-hidden="true">4.</strong> P2P层</a></li><li class="chapter-item expanded "><a href="../2.核心协议/2.共识层.html" class="active"><strong aria-hidden="true">5.</strong> 共识层</a></li><li class="chapter-item "><a href="../2.核心协议/3.消息路由层.html"><strong aria-hidden="true">6.</strong> 消息路由层</a></li><li class="chapter-item "><a href="../2.核心协议/4.执行层.html"><strong aria-hidden="true">7.</strong> 执行层</a></li><li class="chapter-item "><a href="../2.核心协议/相关概念介绍/简介.html"><strong aria-hidden="true">8.</strong> 相关概念</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../2.核心协议/相关概念介绍/共识委员会数量如何确定？.html"><strong aria-hidden="true">8.1.</strong> 共识委员会数量如何确定？</a></li><li class="chapter-item "><a href="../2.核心协议/相关概念介绍/P2P层是如何降低恶意攻击的？.html"><strong aria-hidden="true">8.2.</strong> P2P层是如何降低恶意攻击的？</a></li></ol></li><li class="chapter-item "><li class="part-title">链钥密码学（Chain key）</li><li class="chapter-item affix "><li class="part-title">容器(Canister)</li><li class="chapter-item affix "><li class="part-title">网络神经系统(NNS)</li><li class="chapter-item affix "><li class="part-title">区块链网络服务</li><li class="chapter-item affix "><li class="part-title">互联网身份</li><li class="chapter-item affix "><li class="part-title">IC里的密码学</li><li class="chapter-item affix "><li class="part-title">开发Dapp</li><li class="spacer"></li><li class="chapter-item affix "><a href="../词汇表.html">词汇表</a></li><li class="chapter-item affix "><a href="../贡献者名单.html">贡献者名单</a></li><li class="chapter-item affix "><a href="../参考资料.html">参考资料</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">互联网计算机漫游指南</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NeutronStarDAO/ConstellationBook-Chinese" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');

                    // Get viewed page store
                    var viewed_key = 'mdbook-viewed';
                    var viewed_map = {};
                    try {
                        var viewed_storage = localStorage.getItem(viewed_key);
                        if (viewed_storage) {
                            viewed_map = JSON.parse(viewed_storage)
                        }
                    } catch (e) { }

                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                        
                        // Apply viewed style
                        if (viewed_map[link.pathname]) {
                            link.classList.add('md-viewed')
                        }
                    }); 

                    // Mark viewed after 30s
                    setTimeout(function() {
                        viewed_map[location.pathname] = 1;
                        localStorage.setItem(viewed_key, JSON.stringify(viewed_map));
                    }, 30000)
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>
                    <main>
                        <h1 id="共识层简述"><a class="header" href="#共识层简述">共识层简述</a></h1>
<br>
<h2 id="啥pouw不是pow吗"><a class="header" href="#啥pouw不是pow吗">啥？PoUW？不是PoW吗？</a></h2>
<p>说起 IC 的共识，你看这个名字：PoUW，Proof of Useful Work 。有效工作证明。</p>
<p>是不是似曾相识？</p>
<img src="assets/2.共识层/image-20230131200036914.png" style="zoom:20%;float: left; margin-right: 55px;" />
<p>PoW！哈哈哈哈 :) </p>
<p>PoW （Proof of Work）是比特币的共识算法，从现在的角度看非常低效，好在还比较安全。工作量证明就像学校组织了一场考试，只有考满分的同学有资格把名字挂在教育局的荣誉墙上并奖励一枚比特币。而且学校是随时随地开放的，谁都可以随时来参加考试，答完所有题后自动出成绩。有一个同学满分之后，所有同学的试卷立即作废。因为已经有答案了诞生了（满分试卷），其他人还必须把满分试卷抄下来，然后开始下一次考试。</p>
<p>PoUW 这所学校把考生随机分成了几个班级，考试在每个班里进行。而且不是谁都可以进入学校的，只有老师可以加入。每个班级大家共同完成一份试题。因为大家都是经验丰富的老司机，所以用摇骰子的方式决定谁做第一题、谁做第二题 ...... 答完题后大家还要讨论一下，对各方意见达成统一，然后交卷。奖励班里每个人平分。</p>
<p>看看，多高效 ~ 😉😎 </p>
<p>PoUW 比 PoW 多了一个 U ，主要特性是提高了不少性能，让节点机器少做无用功。PoUW 不会人为制造困难的哈希计算，它将算力尽可能的放在为用户服务上。大部分资源（CPU、内存）用于实际 canister 中代码的执行上。</p>
<br>
<h2 id="怎样达成共识"><a class="header" href="#怎样达成共识">怎样达成共识</a></h2>
<p>但不管怎么说，人家比特币是区块链的祖师爷。虽然共识低效，但也好歹是一种分布式问题的解决方案。</p>
<p>中本聪的比特币对 “ 拜占庭将军 ” 问题是一个可行的解决方案。</p>
<p>简单来说，这个问题包括了试图通过在一个不可靠、具有潜在威胁的网络中，通过信息交流来达成一个行动协议共识。中本聪的解决方案是使用工作量证明的概念在没有中央信任机构下达成共识，这代表了分布式计算的科学突破，并已经超越了货币广泛的适用性。</p>
<p>但是共识只能这样达成吗？有没有一种安全性不低，还更节能高效的方式呢？</p>
<br>
<p>那我们先得了解共识的本质是什么？</p>
<p>为了在一个全球范围内的分布式网络中，保持数据一致性。</p>
<p>比特币的做法是所有人靠算力竞争谁打包的区块有效，然后大家都复制他的区块。这样比特币交易账本有了多份副本，也达到保持所有节点数据一致的目的。但是效率非常低。</p>
<br>
<p>我们不妨看一下这里保持一致的逻辑：</p>
<p>目的：保持所有节点上数据的一致性。</p>
<p>方法：靠某种手段选一个节点出块，其他节点复制那个节点出的区块。不能一直选同一个节点，选谁出块是毫无规律可言的。</p>
<br>
<p>我们忽略方法只分析目的。既然目的是保持节点们的数据一致，那只要让节点们同时收到消息，不就解决了嘛。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230226122241692.png" alt="image-20230226122241692" style="zoom:21%;" />
</div>
<p>但实际网络环境可不允许，信息传输总有长短不一的延迟，何况节点们本来就不在同一地点，客户端的位置也有远有近，传输距离都不一样。简直乱成一锅粥。根本不可能保证所有节点在同时收到消息。那怎么办呢？</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230226125016557.png" alt="image-20230226125016557" style="zoom:33%;" />
</div>
<p>答案很简单，建一个 “ 中转站 ” 就能解决这个问题。不管是从哪发过来的消息，先进中转站里排好队，然后由中转站把消息和执行顺序发给节点们。节点们只要按照中转站给的顺序依次执行操作就能保证数据一致了！</p>
<br>
<p>但先别笑，因为还有一个大问题：中心化。所有节点都得听中转站的命令，中转站说按 ABDC 的顺序执行消息，节点就得 ABDC 。兜兜转转一大圈，结果回到原点了。那怎么才能以去中心化的方式给消息排序呢。</p>
<br>
<p>去中心化的方式其实很简单，就是做一件事完全不依赖某一个人。没有 “ 上司、管理者 ” ，很民主，大家一起选出一个共识。这活谁来了都能干，谁走了也不影响系统继续运行。（除非都走光，不过有经济激励就总有人来）</p>
<p>所以怎么设计好呢？让节点们对执行消息的顺序达成共识，把中转站的职能改为去中心化的方式进行。</p>
<br>
<p><strong>IC 是这样设计的</strong>：（IC 把节点抽象成子网里的副本 Replica）</p>
<p>肯定不能依赖中转站。虽然消息到达每个副本的时间可能不一样（即执行消息的顺序不一样），但是所有副本必须按相同顺序执行消息。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230226151334415.png" alt="image-20230226151334415" style="zoom:27%;" />
</div>
<p>那如果大家的顺序都不一样，到底按谁的顺序来执行呢？用随机数选！（IC 的随机信标）</p>
<p>IC 底层使用了一种可验证的随机数（Verifiable Random Function, VRF）。它能产生不可预测的随机数，而且大家都可以验证随机数不是伪造的。</p>
<br>
<p>VRF 用了 BLS 阈值签名方案。BLS 阈值签名算法使用 DKG 给副本们分发私钥片段，这是一种非交互式的分布式密钥生成协议。DKG 可以在成员之间分发私钥片段。不需要可信方，不依赖某一个成员分发私钥片段，避免了单点故障。大家拿着私钥片段去签名信息，签名达到阈值后就可以聚合形成完整的签名。签名过程是非交互的，任何第三方都可以在收到足够多的份额后执行聚合。任何人都可以用唯一的公钥验证签名，公钥也记录在 NNS 的注册表里。</p>
<br>
<p>如果消息是确定的，无论哪些私钥片段参与了签名，只要达到阈值数量（生成随机信标的阈值是三分之一），最终都能聚合成唯一的签名信息。比如下图的阈值是 6 。16 个副本为了生成本轮的随机信标签名，只要签名大于 6 就可以聚合。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230303104523514.png" alt="image-20230303104523514" style="zoom:25%;" />
</div>
<p>只要敌人拿到的私钥片段小于三分之一，就无法干扰到 BLS 阈值签名。也无法预测签名结果，因为私钥片段不够嘛，也就是说任何人不知道签名结果。</p>
<blockquote>
<p>子网的共识最多对抗小于三分之一的恶意副本；如果恶意副本小于三分之一，那它能做的也只有签名或者不签名，没法干扰阈值签名的最终结果，也没法阻止签名产生；如果恶意副本大于等于三分之一，子网已经被破坏，随机数也就无所谓了。所以随机信标的阈值比较低，是三分之一。产生随机数的速度能快一点。</p>
</blockquote>
<ul>
<li>传统的 RSA 或者 ECDSA 算法中，自己掌握私钥，消息又是公开的，相当于自己知道签名结果。私钥泄露之后别人也可以提前知道签名结果。</li>
<li>而在 BLS 阈值签名算法中，由一群人掌管私钥片段。签名的人他自己没有完整私钥，所以也不知道签名结果。只有大家签完聚合之后才知道签名。在整个过程中，全局私钥没有任何人知道，但签名的结果是大多数人认可的结果。由一群人产生签名，任何个人都无法预测签名的结果，单个人无法阻止签名发布。</li>
</ul>
<p>这就可以作为随机信标，为哪个副本出块提供参考。这个随机数也是一个共识的结果，而且无法被单个人篡改。而且，这个是可以持续安全地产生随机数，只要每轮用出不同的信息来签名。这个不同的信息当然就是上一轮的随机信标和一些区块的 dkg_id ，这样一来每轮签名的信息都不一样。</p>
<p>IC 的随机信标、公证、敲定、随机磁带、认证复制状态都用了 BLS 阈值签名。</p>
<br>
<h2 id="解决方案"><a class="header" href="#解决方案">解决方案</a></h2>
<p>我们来仔细看看 IC 的共识协议怎么出块：</p>
<h3 id="首先是出块前的准备"><a class="header" href="#首先是出块前的准备">首先是出块前的准备</a></h3>
<p>共识协议按照轮次进行出块。比如第 1 轮对创世区块达成了共识，第 6 轮就负责第 6 个区块。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230227223208655.png" alt="image-20230227223208655" style="zoom:25%;" />
</div>
<p>在开始之前，子网先根据副本的数量，随机选择一些副本组成一个 “ 共识委员会 ” 。如果副本数量太少，所有副本都会加入委员会。委员会内的成员负责打包出块，所以子网里副本数量非常多也不会影响性能。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230227231451557.png" alt="image-20230227231451557" style="zoom:20%;" />
</div>
<p>子网里还有个 “ <strong>时期</strong> ” （Epoch）的概念。一个时期大约是几百个轮次。NNS 可以对每个子网的时期进行调整。</p>
<p>每个子网在包含多轮（通常大约是几百轮）的时期内运行。每个时期有不同的副本组成委员会。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230227232831136.png" alt="image-20230227231451557" style="zoom:20%;" />
</div>
<p>每个时期结束时，通过随机信标选出下个时期的共识委员会成员，而现在的共识委员会成员将会在下个时期全部转为随机信标委员会成员。</p>
<p>新时期的第一个块里包含有这个时期的共识委员会名单、随机信标委员会名单。</p>
<br>
<p>并且新时期开始时会重新给成员们分发一次私钥片段，这个过程叫<a href="">主动秘密再共享</a>。这样做的原因有二：</p>
<ul>
<li>
<p>当子网的成员发生变动时，再共享可以确保任何新成员都有新的私钥片段，而任何退出子网的成员就没有新的私钥片段了。</p>
</li>
<li>
<p>即使每个时期有少量的私钥片段泄露给攻击者，也不能使攻击者对共识产生威胁。</p>
</li>
</ul>
<br>
<p>共识委员会数量和子网中副本成员总数有关。为了提高可扩展性，在小规模网络中，委员会成员可以是所有副本；在大规模网络中，委员会成员是所有副本中的一部分，并在每一个时期不断变化。</p>
<p>共识委员会成员的数量不能太多也不能太少。太少了不安全，太多了又影响共识速度。</p>
<p>所以委员会数量和成员总数的关系有一个数学模型描述：当子网里的成员总数趋近无限大时，超几何分布趋于二项分布，即不放回随机抽样的方式趋向于放回的随机抽样。因为副本成员总数无限大嘛，那放回和不放回就没有区别了。关于如何确定共识委员会的数量，这里就不展开讨论了，感兴趣可以看<a href="%E7%9B%B8%E5%85%B3%E6%A6%82%E5%BF%B5%E4%BB%8B%E7%BB%8D/%E5%85%B1%E8%AF%86%E5%A7%94%E5%91%98%E4%BC%9A%E6%95%B0%E9%87%8F%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9A%EF%BC%9F.html">这里</a>的介绍。</p>
<br>
<p>完成准备工作就可以出块了。</p>
<br>
<h3 id="开始出块block-maker"><a class="header" href="#开始出块block-maker">开始出块（Block maker）</a></h3>
<p>每一轮开始，都由上一轮产生的随机信标生成一个排名，排名决定了成员出块的权重。权重最高的老大优先出块。（如下图，排名为 5 个共识委员会成员分配一个 0 ~ 4 的数字，0 的权重最高）</p>
<p>正常情况下，老大诚实而且网络连接正常，老大负责出块。其他人都等着公证老大的区块，这时候即使收到老二的区块也不公证，非得等着老大的区块。</p>
<p>与此同时，随机信标委员会也将上一轮信标的哈希和这轮的 NiDKG 记录打包、签名、广播。在签名达到阈值时，产生本轮的随机信标，也就决定了下一轮的出块权重。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230531104931802.png" alt="image-20230531104931802" style="zoom:25%;" />
</div>
<br>
<p>一个非创世区块里一般包含：</p>
<ul>
<li>上一个区块公证之后到打包这个区块时，这一段时间内收到的消息，我们叫它 “ <strong>荷载</strong> ” （payload）。</li>
<li>上一个区块的哈希。</li>
<li>出块副本的排名。</li>
<li>区块的高度。</li>
</ul>
<p>当组成区块后，负责出块的副本会生成一份<strong>区块提案</strong>，包括：</p>
<ul>
<li>区块本身。</li>
<li>自己的身份标识。</li>
<li>自己对这个区块的签名。</li>
</ul>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302124528188.png" alt="image-20230302124528188" style="zoom:25%;" />
</div>
<p>然后将其区块提案广播给其他成员。</p>
<br>
<p>老大出块，广播给大家，公证完成，因为只有老大的一个块被公证所以不用敲定，直接进入下一轮，这是最快的情况，也是最普通的情况。大约 1 秒敲定一个块。（乐观响应：协议会以实际网络延迟而不是网络延迟上限继续执行）</p>
<p>如果等了一段时间，一直没收到老大的区块，可能是老大网络不太好，也可能是机器出现了故障；这时大家才认可老二或者老三的区块，给他们的区块做公证。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230531104728709.png" alt="image-20230531104728709" style="zoom:80%;" />
</div>
<p>系统有一个约定好的等待时间，如果在一段时间之内没有收到老大的区块，就在第二段时间期待老二的区块了。然后是在第三个时间段期待老三的区块，假如老三是自己，那就自己出块 ...... </p>
<br>
<h3 id="公证notarization"><a class="header" href="#公证notarization">公证（Notarization）</a></h3>
<p><strong>公证只验证区块的合理性</strong>，公证过的区块不代表已经达成共识。这保证了当前轮次中的多个区块里，至少有一个区块能得到公证。</p>
<p>因此，公证并不意味着共识，也不需要共识。如果多个区块具有相同的权重，那么这些区块都会被签名。</p>
<br>
<p>公证时，共识委员会的成员验证以下三方面的信息：</p>
<ul>
<li>区块里应该有上一轮已经公证过的区块的哈希。</li>
<li>区块的荷载必须满足一些特定条件，比如要考虑这轮验证后的状态等等（是对荷载内容的具体规定，这些条件是独立于共识协议的）。</li>
<li>负责出这个块的副本的排名必须对应随机信标里的排名（比如排名第二的副本说自己排第一，那这个块就得不到公证）。 </li>
</ul>
<br>
<p>如果区块的信息没问题，负责验证的副本先对区块高度和区块的哈希签名，然后把刚才的签名连同哈希、高度和自己的身份标识组成 “ <strong>公证片段</strong> ” 。把自己公证过的公证片段广播出去。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302153935674.png" alt="image-20230302153935674" style="zoom:20%;" />
</div>
<p>公证也用了 BLS 阈值签名。当有副本收到足够多（阈值是三分之二）的公证片段时，聚合签名片段形成对这个区块的公证。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302165334450.png" alt="image-20230302165334450" style="zoom:14%;" />
</div>
<p>聚合之后的公证信息包括区块哈希、区块高度、聚合签名和三分之二以上的身份标识。副本要么发现收集到了足够的公证片段，自己聚合为公证；要么从别人那里收到已经聚合好的公证。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230316125350561.png" alt="image-20230316125350561" style="zoom:25%;" />
</div>
<br>
<p>形成公证之后依然是广播出去。当其他成员收到已经公证过的区块后，转发广播一遍公证过的区块，并且不再给其他区块生成公证片段。</p>
<p>比如下图拿手机的女孩和小蓝帽进入了下一轮共识。而女孩发给另外 3 个人时网络中断了 700 毫秒，由小蓝帽转发的消息起了关键作用，不然五缺三也没法玩了。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302163949099.png" alt="image-20230302163949099" style="zoom:21%;" />
</div>
<br>
<p>如果老大的块有问题，公证失败，老二的出块权重就是现在最大的。如果老二老三的块都经过了公证，下一轮的老大会选择在权重大的区块后面出块。就像下面图中的第 5 轮、第 6 轮那样，老二的区块权重大于老三的区块权重。把所有区块的权重加起来，黄色和紫色的区块组成的链是权重最大的链。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302111740043.png" alt="image-20230302111740043" style="zoom:23%;" />
</div>
<br>
<p>为了能让效率最大化，每个副本都有个 “ 最长的等待时间 ” （Delay functions），是接受新区块或对区块投票之前的最长等待时间，过了这个时间就不等了。这个等待时间的长短是因人而异的，每个副本都不一样。</p>
<p>如果有的副本因为网络延迟，连续好几轮都没收到消息，那就是因为它等待的时间太短了。消息还没发过来，它就不等了。如果最终确认失败，所有诚实副本都会多等一会，直到收到最终确认。</p>
<p>这时副本可以适当增加延迟，多等一会。这样在下一轮更有可能收到消息。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230702192709878.png" style="zoom:50%;" />
</div>
<br>
<h3 id="敲定finalization"><a class="header" href="#敲定finalization">敲定（Finalization）</a></h3>
<p>因为有时候会产生不止一个区块（老大没响应时，老二老三为了赶时间都可能出块）。这就需要有个敲定环节了，敲定将确定下来大家都公证过的唯一区块。那么大家都认同的这个区块之前的区块也得到了隐性敲定，其他分支便会失效。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230228204613513.png" alt="image-20230228204613513" style="zoom:20%;" />
</div>
<p>敲定的过程具体为：</p>
<p>在副本发现一个经过公证的区块之后，就会开始检查自己在这一轮里有没有给别的区块公证过。如果没有给别的区块公证过，那么它会为区块广播一个 “ <strong>敲定片段</strong> ” 。用来证明自己只为这一个区块发布过公证片段。</p>
<br>
<p>要实现一个区块的敲定，需要三分之二个不同的副本发布敲定片段，然后聚合为某个区块的敲定。敲定片段和公证片段的格式完全相同（但是通过特定方式标注以防止混淆）。收到敲定后的区块之后，和公证环节一样，都会向其他成员广播一遍。</p>
<br>
<p>注意：副本不会一直等待敲定片段聚合为最终的敲定，才进入下一轮。副本只是收到某个高度的敲定片段后检查一下自己有没有公证除了那个块之外的块，然后广播出去自己签名的敲定片段；或者转发敲定片段。</p>
<br>
<p>例如，一个副本在第 11 轮收到了第 10 轮的<strong>敲定片段</strong>。这时候它就检查一下自己当时的行为，然后广播出答复。</p>
<p>如果过了一会儿，收到了第 10 轮的区块的<strong>敲定</strong>，也就可以敲定第 10 轮。那从第 1 轮到第 10 轮敲定的区块，这一条路上的所有区块对可以视为敲定了。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302195311269.png" alt="image-20230302195311269" style="zoom:21%;" />
</div>
<p>这些已经敲定的区块可以被认为是大家都确认过安全的，意味着所有的副本都认同了敲定的区块所在的分支。在区块 10 这个区块高度，有且仅有这个区块通过了公证。那么副本在这个高度就达成了共识。</p>
<br>
<p>比如：</p>
<p>如果某个副本在第 5 轮只给一个区块生成过公证片段，副本还会发一个敲定片段，然后进入第 6 轮共识。如果之后收到了最终的敲定，就认为包含敲定的分支是有效的。敲定之后的区块如果没有分叉的话，就一直没问题，不用敲定也行。</p>
<p>可能第 4 轮有二分之一的副本为老大、老二的区块都生成了公证片段，另外二分之一的副本只为老大生成过公证片段。那么敲定片段由只为老大公证过的副本提出，最终达不到阈值，而没法获得敲定。只有二分之一的副本生成过老二区块的公证片段，所以老二的区块没有获得公证。</p>
<p>而在第 3 轮，老二、老三的区块都得到了公证。因为网络故障，大部分副本给老二、老三都公证过，所以没法完成敲定。但诚实的副本们都会选择在老二的区块后面继续共识。等后面第 5 轮敲定了，就代表第 3 轮老二的区块得到了敲定。</p>
<div class="center-image">
    <img src="assets/2.共识层/image-20230302212147233.png" alt="image-20230302212147233" style="zoom:23%;" />
</div>
<p>总之，如果一个区块没有得到敲定，副本会继续留在这轮等一下，等着区块被敲定。</p>
<p>如果在这轮结尾，仍然没有任何区块被敲定，就先进入下一轮，并在下一轮试图为上一轮的区块完成敲定。</p>
<p>在后续的轮次中，只要网络恢复同步，并且领导者诚实，那一轮的区块就会被敲定。</p>
<p>一旦某一轮的区块被敲定，之前所有的轮次的区块链都会被正式敲定。公证仅确保区块树中存在该区块，而敲定将其确定在主链上。</p>
<p>相比许多其他区块链，IC 共识协议的优势在于采用了异步敲定。在其他区块链中，节点通常需要找到最长链。如果链出现分叉后，节点需要等待一段时间找到最长链。如果因为网络故障错过一些区块，也就找不到最长链了，这时还需要去找其他节点同步数据。</p>
<p>IC 协议不依赖找到 “ 最长链 ” 的方式来最终确认区块。IC 的最终确认方法只依赖于密码学签名，而不依赖于整个链的确认。只需少量签名即可观察到共识形成的一个块，而不需要等待整个链的确认过程。在短时间内就能消除分叉，敲定的速度可以在不到一秒的时间内实现。</p>
<br>
<p><strong>共识的过程到这里就讲完啦！</strong></p>
<br>
<p><strong>总结一下</strong>，共识委员会的成员进入新的轮次里，要做 3 件事：</p>
<p>（1）看看自己排第几，然后决定自己是否出块</p>
<p>（2）公证区块</p>
<p>（3）观察区块，找到主链，忽略失效的分支</p>
<p>共识委员会在下一个时期变成随机信标委员会，负责产生每轮的随机信标。</p>
<br>
<p>共识过程为老大出块，大家验证之后给出公证片段，公证片段数量达到阈值聚合为公证，进入下一轮次。敲定不是每轮必须要做完的。</p>
<p>IC 共识协议确保了当存在个别恶意攻击时，IC 的性能会柔性下降，而不是直接卡死。共识协议目前倾向于在没有故障的 “ 乐观情况 ” 时尽可能提升性能。</p>
<br>
<p>随着协议一轮轮推进，以<strong>创世区块（genesis block）<strong>为起点的区块连接成链，不断延长。每个区块都包含一个</strong>荷载 (payload)</strong>，由一系列输入和父区块的哈希组成。</p>
<p>诚实的副本对区块链的路径有一致的视角，区块里记录着已经排好序的消息，由消息路由层发往执行层处理。</p>
<br>
<p>附录：</p>
<p>两类共识机制对比</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center"></th><th style="text-align: center">经典公链共识机制</th><th style="text-align: center">联盟链共识机制</th><th style="text-align: center">互联网计算机共识机制</th></tr></thead><tbody>
<tr><td style="text-align: center">写入顺序</td><td style="text-align: center">先写入后共识</td><td style="text-align: center">先共识后写入</td><td style="text-align: center">先写入后共识</td></tr>
<tr><td style="text-align: center">典型算法</td><td style="text-align: center">PoW、PoS、DPos</td><td style="text-align: center">PBFT、BFT</td><td style="text-align: center">PoUW</td></tr>
<tr><td style="text-align: center">共识流程</td><td style="text-align: center">大概率一致就确认</td><td style="text-align: center">确认一致后再P2P广播沟通投票</td><td style="text-align: center">通过随机数选择出块节点</td></tr>
<tr><td style="text-align: center">复杂性</td><td style="text-align: center">计算复杂度高</td><td style="text-align: center">网络复杂度高</td><td style="text-align: center">网络复杂度高</td></tr>
<tr><td style="text-align: center">是否分叉</td><td style="text-align: center">是</td><td style="text-align: center">否</td><td style="text-align: center">否</td></tr>
<tr><td style="text-align: center">安全阈值</td><td style="text-align: center">二分之一</td><td style="text-align: center">三分之一</td><td style="text-align: center">三分之一</td></tr>
<tr><td style="text-align: center">节点数量</td><td style="text-align: center">节点数量可随时随意变动</td><td style="text-align: center">节点数量不能随意变动，数量越多性能越低</td><td style="text-align: center">节点数量不能随意变动，数量多对性能影响不大</td></tr>
<tr><td style="text-align: center">应用场景</td><td style="text-align: center">非许可链</td><td style="text-align: center">许可链</td><td style="text-align: center">半许可链，靠DAO投票决定节点是否加入</td></tr>
</tbody></table>
</div><br>
<p>几种共识算法对比</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: center">共识算法</th><th style="text-align: center">PoW</th><th style="text-align: center">PoS</th><th style="text-align: center">DPoS</th><th style="text-align: center">PBFT</th><th style="text-align: center">VRF</th><th style="text-align: center">PoUW</th></tr></thead><tbody>
<tr><td style="text-align: center">节点管理</td><td style="text-align: center">无许可</td><td style="text-align: center">无许可</td><td style="text-align: center">无许可</td><td style="text-align: center">有许可</td><td style="text-align: center">有许可</td><td style="text-align: center">DAO投票许可</td></tr>
<tr><td style="text-align: center">共识延时</td><td style="text-align: center">高</td><td style="text-align: center">低</td><td style="text-align: center">低</td><td style="text-align: center">低</td><td style="text-align: center">低</td><td style="text-align: center">超低</td></tr>
<tr><td style="text-align: center">吞吐量</td><td style="text-align: center">低</td><td style="text-align: center">高</td><td style="text-align: center">高</td><td style="text-align: center">高</td><td style="text-align: center">高</td><td style="text-align: center">高</td></tr>
<tr><td style="text-align: center">节能</td><td style="text-align: center">否</td><td style="text-align: center">是</td><td style="text-align: center">是</td><td style="text-align: center">是</td><td style="text-align: center">是</td><td style="text-align: center">是</td></tr>
<tr><td style="text-align: center">安全边界</td><td style="text-align: center">1/2</td><td style="text-align: center">1/2</td><td style="text-align: center">1/2</td><td style="text-align: center">1/3</td><td style="text-align: center">1/3</td><td style="text-align: center">1/3</td></tr>
<tr><td style="text-align: center">代表应用</td><td style="text-align: center">Bitcoin</td><td style="text-align: center">Ethereum</td><td style="text-align: center">BitShare</td><td style="text-align: center">Fabric</td><td style="text-align: center">Algorand</td><td style="text-align: center">Internet Computer</td></tr>
<tr><td style="text-align: center">扩展性</td><td style="text-align: center">好</td><td style="text-align: center">好</td><td style="text-align: center">好</td><td style="text-align: center">差</td><td style="text-align: center">差</td><td style="text-align: center">无限</td></tr>
</tbody></table>
</div>
                        <div id="giscus-container"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../2.核心协议/1.P2P层.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../2.核心协议/3.消息路由层.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../2.核心协议/1.P2P层.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../2.核心协议/3.消息路由层.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
        var pagePath = "2.核心协议/2.共识层.md"
        </script>


        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../assets/custom.js"></script>
        <script type="text/javascript" src="../assets/bigPicture.js"></script>


    </body>
</html>