<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Postæ¨¡å— - äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The constellation book for you.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.png">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/style.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../about.html">ğŸ‘½äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—ğŸ›¸</a></li><li class="chapter-item affix "><li class="part-title">å»ä¸­å¿ƒåŒ–ä¹‹æ—…ğŸ”</li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/é€ æ¢¦å®¶çš„å†’é™©ä¹‹æ—….html">é€ æ¢¦å®¶çš„å†’é™©ä¹‹æ—…</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æœªæ¥å·²æ¥.html">æœªæ¥å·²æ¥</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/åŠ å¯†æœ‹å…‹çš„é‚£äº›äº‹.html">åŠ å¯†æœ‹å…‹çš„é‚£äº›äº‹</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/åŒºå—é“¾æ˜¯å•¥ï¼Ÿ.html">åŒºå—é“¾æ˜¯å•¥ï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/ä»€ä¹ˆæ˜¯ä»¥å¤ªåŠï¼Ÿ.html">ä»€ä¹ˆæ˜¯ä»¥å¤ªåŠï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æˆ‘çš„ç½‘ç»œéšç§å‘¢ï¼Ÿ.html">æˆ‘çš„ç½‘ç»œéšç§å‘¢ï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æ¯”ç‰¹å¸.html">æ¯”ç‰¹å¸</a></li></ol></li><li class="chapter-item "><li class="part-title">äº†è§£ICğŸ“¡</li><li class="chapter-item "><a href="../1.äº†è§£IC/1.äº†è§£IC.html">äº†è§£IC</a></li><li class="chapter-item "><a href="../1.äº†è§£IC/ICP=Web3.0.html">ICP = Web 3.0</a></li><li class="chapter-item affix "><li class="part-title">æ ¸å¿ƒåè®®â­</li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/1.P2På±‚.html">P2På±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/2.å…±è¯†å±‚.html">å…±è¯†å±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/3.æ¶ˆæ¯è·¯ç”±å±‚.html">æ¶ˆæ¯è·¯ç”±å±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/4.æ‰§è¡Œå±‚.html">æ‰§è¡Œå±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/ç®€ä»‹.html">ç›¸å…³æ¦‚å¿µ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/å…±è¯†å§”å‘˜ä¼šæ•°é‡å¦‚ä½•ç¡®å®šï¼Ÿ.html">å…±è¯†å§”å‘˜ä¼šæ•°é‡å¦‚ä½•ç¡®å®šï¼Ÿ</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/P2På±‚æ˜¯å¦‚ä½•é™ä½æ¶æ„æ”»å‡»çš„ï¼Ÿ.html">P2På±‚æ˜¯å¦‚ä½•é™ä½æ¶æ„æ”»å‡»çš„ï¼Ÿ</a></li></ol></li><li class="chapter-item "><li class="part-title">é“¾é’¥å¯†ç å­¦ğŸª„</li><li class="chapter-item "><a href="../3.é“¾é’¥å¯†ç å­¦(ChainKey)/1.ChainKey.html">Chain Key</a></li><li class="chapter-item "><a href="../3.é“¾é’¥å¯†ç å­¦(ChainKey)/VetKeys.html">VETKeys</a></li><li class="chapter-item affix "><li class="part-title">å®¹å™¨ğŸ§°</li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/1.Canister.html">Canister</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/2.Motoko.html">Motoko</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/3.éƒ¨ç½²è‡ªå·±çš„Canister.html">éƒ¨ç½²Canister</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/4.XRC.html">XRC</a></li><li class="chapter-item affix "><li class="part-title">ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)âš™ï¸</li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/1.NNS.html">NNS</a></li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/2.DAO.html">DAO</a></li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/3.ç»æµæ¨¡å‹.html">ç»æµæ¨¡å‹</a></li><li class="chapter-item affix "><li class="part-title">åŒºå—é“¾ç½‘ç»œæœåŠ¡ğŸ¯</li><li class="chapter-item "><a href="../6.åŒºå—é“¾ç½‘ç»œæœåŠ¡/5.å¯ä¿¡æ‰§è¡Œç¯å¢ƒ.html">å¯ä¿¡æ‰§è¡Œç¯å¢ƒ</a></li><li class="chapter-item "><a href="../6.åŒºå—é“¾ç½‘ç»œæœåŠ¡/6.é“¾ä¸Šéšæœºæ•°.html">é“¾ä¸Šéšæœºæ•°</a></li><li class="chapter-item affix "><li class="part-title">äº’è”ç½‘èº«ä»½ğŸ”‘</li><li class="chapter-item "><a href="../7.äº’è”ç½‘èº«ä»½/1.ii.html">äº’è”ç½‘èº«ä»½</a></li><li class="chapter-item "><a href="../7.äº’è”ç½‘èº«ä»½/3.pid.html">pid</a></li><li class="chapter-item affix "><li class="part-title">ICé‡Œçš„å¯†ç å­¦ğŸ”’</li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/åŸºç¡€å¯†ç å­¦çŸ¥è¯†.html">åŸºç¡€å¯†ç å­¦ä»‹ç»</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/BLSç­¾å.html">BLS</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/ç§˜å¯†å…±äº«.html">ç§˜å¯†å…±äº«</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/å“ˆå¸Œç®—æ³•.html">å“ˆå¸Œç®—æ³•</a></li><li class="chapter-item affix "><li class="part-title">å¼€å‘DAppğŸŒŸ</li><li class="chapter-item "><a href="../9.Dappå¼€å‘/å®‰è£…å¼€å‘ç¯å¢ƒ.html">å®‰è£…å¼€å‘ç¯å¢ƒ</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/dfxå¸¸ç”¨å‘½ä»¤.html">dfxå¸¸ç”¨å‘½ä»¤</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/Motoko.html">Motoko</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/1.å…¥é—¨DApp.html">å…¥é—¨DApp</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/2.è®¾è®¡DApp.html">è®¾è®¡DApp</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/3.å¼€å‘Proton.html">å¼€å‘Proton</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/4.Useræ¨¡å—.html">Useræ¨¡å—</a></li><li class="chapter-item expanded "><a href="../9.Dappå¼€å‘/5.Postæ¨¡å—.html" class="active">Postæ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/6.Feedæ¨¡å—.html">Feedæ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/7.Fetchæ¨¡å—.html">Fetchæ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/8.å…±äº«ç±»å‹.html">å…±äº«ç±»å‹</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/9.å®Œæˆ.html">å®Œæˆ</a></li><li class="spacer"></li><li class="chapter-item affix "><a href="../è¯æ±‡è¡¨.html">è¯æ±‡è¡¨</a></li><li class="chapter-item affix "><a href="../è´¡çŒ®è€…åå•.html">è´¡çŒ®è€…åå•</a></li><li class="chapter-item affix "><a href="../å‚è€ƒèµ„æ–™.html">å‚è€ƒèµ„æ–™</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NeutronStarDAO/ConstellationBook-Chinese" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');

                    // Get viewed page store
                    var viewed_key = 'mdbook-viewed';
                    var viewed_map = {};
                    try {
                        var viewed_storage = localStorage.getItem(viewed_key);
                        if (viewed_storage) {
                            viewed_map = JSON.parse(viewed_storage)
                        }
                    } catch (e) { }

                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                        
                        // Apply viewed style
                        if (viewed_map[link.pathname]) {
                            link.classList.add('md-viewed')
                        }
                    }); 

                    // Mark viewed after 30s
                    setTimeout(function() {
                        viewed_map[location.pathname] = 1;
                        localStorage.setItem(viewed_key, JSON.stringify(viewed_map));
                    }, 30000)
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>
                    <main>
                        <h2 id="post"><a class="header" href="#post">Post</a></h2>
<p>ç”¨æˆ·é€šè¿‡ Feed å‘å¸ƒå’Œè·å–åŠ¨æ€ï¼Œæ‰€æœ‰çš„å¸–å­éƒ½å­˜åœ¨ Bucket é‡Œã€‚é€šçŸ¥æŠ“å–çš„åŠŸèƒ½åˆ™é€šè¿‡ Fetch è¿›è¡Œå¤„ç†ã€‚</p>
<p>æˆ‘ä»¬ä¸‹ä¸€ä¸ªè¦å®ç°çš„æ˜¯ Post æ¨¡å—ã€‚ä½†æ˜¯æˆ‘ä»¬éœ€è¦ç”¨çš„ç±»å‹æœ‰å¸–å­ã€ç‚¹èµã€è¯„è®ºï¼Œè¿˜è¦å’Œå…¶ä»– Canister äº¤äº’ï¼Œè€Œä¸”è¿™äº›ç±»å‹åœ¨ Feed ã€Fetch é‡Œè¿˜éœ€è¦ç”¨ã€‚</p>
<p>æ‰€ä»¥å¯¹äºè¦å…¨å±€å…±äº«çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠå®ƒæ”¾åœ¨æ¨¡å—æ–‡ä»¶å¤¹ä¹‹å¤–ï¼š</p>
<pre><code>src
  â”œâ”€â”€ feed
  â”œâ”€â”€ fetch
  â”œâ”€â”€ post
  â”œâ”€â”€ user
  â”œâ”€â”€ types.mo  ğŸ‘ˆ
  â””â”€â”€ utils.mo
</code></pre>
<p>åœ¨ä½¿ç”¨æ—¶å…ˆæŠŠ types.mo çš„å†…å®¹å¼•ç”¨åˆ°æ¨¡å—æ–‡ä»¶å¤¹å†…çš„ types.mo é‡Œã€‚å†å¼•å…¥å…¶ä»–æ–‡ä»¶é‡Œã€‚</p>
<br>
<p>æ¯”å¦‚æŠŠå¸–å­è¿™ä¸ªç±»å‹å®šä¹‰å¥½ï¼šä»£è¡¨äº†ç”¨æˆ·å‘å¸ƒçš„å¸–å­ï¼Œç„¶åæ”¾åˆ°å¤–å±‚æ–‡ä»¶å¤¹çš„ types.mo é‡Œï¼Œå…·ä½“å¯ä»¥çœ‹ <a href="./8.%E5%85%B1%E4%BA%AB%E7%B1%BB%E5%9E%8B.html">8.å…±äº«ç±»å‹</a> ã€‚å¸–å­åŒ…æ‹¬äº†å¾ˆå¤šä¿¡æ¯ï¼Œæ¯”å¦‚å¸–å­çš„ ID ã€å‘å¸ƒè€…ã€å¸–å­ç´¢å¼•ã€å‘å¸ƒæ—¶é—´ã€å†…å®¹ã€ç‚¹èµæ•°ã€è¯„è®ºç­‰ç­‰ã€‚</p>
<pre><code class="language-motoko">public type Post = {
    postId: PostId;
    feedCanister: Principal;
    index: Nat;
    user: UserId;
    content: Text;
    var repost: [Repost];
    var like: [Like];
    var comment: [Comment];
    createdAt: Time;
};
</code></pre>
<br>
<div class="center-image">
<img src="assets/2.è®¾è®¡DApp/image-20231120173647549.png" style="zoom:45%;" />
</div>
<p>æ ¹æ®ä¹‹å‰çš„è®¾è®¡ï¼Œåœ¨ Post æ¨¡å—é‡Œæœ‰ 2 ç§ Canister ï¼šRoot Post å’Œ Bucket ã€‚</p>
<p>Root Post è´Ÿè´£ç»Ÿç­¹ç®¡ç†æ‰€æœ‰çš„ Bucket ï¼š</p>
<ul>
<li>
<p>åˆ›å»ºè¶³å¤Ÿå¤šçš„ Bucket ï¼ˆå§‹ç»ˆä¿æŒ 5 ä¸ªå¯ç”¨ï¼‰ã€‚</p>
</li>
<li>
<p>æŸ¥è¯¢æ‰€æœ‰ Bucket ã€å¯ç”¨çš„ Bucket ã€å·²å­˜æ»¡çš„ Bucket ç­‰ã€‚</p>
</li>
</ul>
<br>
<p>Bucket æ˜¯ç›´æ¥å­˜å‚¨å¸–å­å†…å®¹çš„åœ°æ–¹ï¼š</p>
<ul>
<li>
<p>å­˜å‚¨å¸–å­ã€‚</p>
</li>
<li>
<p>æŸ¥è¯¢å¸–å­æ€»æ•°é‡ã€æ ¹æ®å¸–å­ ID æŸ¥è¯¢å•ä¸ªå¸–å­ã€æŸ¥è¯¢å¤šä¸ªå¸–å­ã€è·å–æœ€æ–°å¸–å­ã€‚</p>
</li>
<li>
<p>åœ¨æ”¶åˆ°æ–°è¯„è®ºåï¼Œé€šè¿‡ CommentFetch é€šçŸ¥ã€‚</p>
</li>
<li>
<p>åŒæ ·ç»´æŠ¤äº†ä¸¤ä¸ªå­æ¨¡å—çš„åœ°å€ï¼Œæä¾›äº†æ›´æ–°å’ŒæŸ¥è¯¢è¿™ä¸¤ä¸ª Canister çš„å‡½æ•°ã€‚</p>
</li>
<li>
<p>Bucket é€šè¿‡ <code>checkBucketMemory</code> å‡½æ•°æ£€æŸ¥å¸–å­æ•°é‡ï¼Œå½“æ¥è¿‘é˜ˆå€¼æ—¶é€šçŸ¥æ ¹å¸–å­æ¨¡å—é‡æ–°åˆ›å»º Bucket ã€‚</p>
</li>
</ul>
<br>
<h3 id="ç®¡ç†canisterrootpostmo"><a class="header" href="#ç®¡ç†canisterrootpostmo">ç®¡ç†Canisterï¼šrootPost.mo</a></h3>
<p>çœ‹çœ‹ Root Post Canister ã€‚Root Post éœ€è¦ç®¡ç† Bucketï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ <code>TrieMap</code> è®°å½•ã€‚ç”¨ <code>TrieMap</code> è®°å½•ä¸‰ç§ä¸åŒçŠ¶æ€çš„ Bucket ï¼š<code>buckets</code> å­˜å‚¨æ‰€æœ‰å·²åˆ›å»ºçš„ Bucket ï¼Œ<code>availableBuckets</code> å­˜å‚¨å¯ç”¨çš„ Bucket ï¼Œ<code>unavailableBuckets</code> å­˜å‚¨å·²ç»å­˜æ»¡çš„ Bucket ã€‚</p>
<p>å› ä¸ºéƒ¨ç½² Canister ä¹‹åéœ€è¦å…ˆåˆ›å»º 5 ä¸ª Canister ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆå§‹åŒ–å‡½æ•°ï¼Œä»¥åŠåç»­å¯ä»¥æ–°å¢ Bucket ã€‚åœ¨åˆ›å»º Bucket æ—¶ï¼Œè¿˜å¾—å‘Šè¯‰ Bucket ç³»ç»Ÿä¸­çš„ Comment Fetch å’Œ Like Fetch çš„ Canister ID ï¼Œæ‰€ä»¥åœ¨ Root Post ä¸­ï¼Œæˆ‘ä»¬è¿˜è¦è®°å½•ã€ä¿å­˜ Comment Fetch å’Œ Like Fetch ã€‚</p>
<p>æœ€åæ˜¯æŸ¥è¯¢æ‰€æœ‰ Bucket ã€æŸ¥è¯¢å¯ç”¨çš„ Bucket ã€æŸ¥è¯¢å·²ç»å­˜æ»¡çš„ Bucket ã€‚</p>
<br>
<p>å…ˆå®šä¹‰ä¸€äº› stable å˜é‡å’Œæ˜ å°„æ¥ä¿å­˜ Bucket ã€‚</p>
<p>åœ¨ Motoko ä¸­ï¼Œ<code>stable</code> å…³é”®å­—ç”¨äºå®šä¹‰ç¨³å®šå˜é‡ï¼ˆStable variablesï¼‰ã€‚è¿™äº›å˜é‡çš„å€¼åº”åœ¨ Canister å‡çº§è¿‡ç¨‹ä¸­ä¿æŒæŒä¹…æ€§ã€‚è¿™æ˜¯ Motoko ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œå®ƒä½¿ç”¨ ICP çš„ç¨³å®šå†…å­˜ï¼ˆStable memoryï¼‰æ¥åœ¨ Canister å‡çº§è¿‡ç¨‹ä¸­ä¿æŒæ•°æ®çš„æŒä¹…æ€§ã€‚ç¨³å®šå†…å­˜æ˜¯ IC å¯ä»¥é•¿æœŸå­˜å‚¨æ•°æ®çš„ç‰¹æ€§ï¼Œä¸å—è¯­è¨€é™åˆ¶ï¼Œ Motoko ã€Rust æˆ–ä»»ä½•å…¶ä»–è¯­è¨€å†™çš„ Canister éƒ½å¯ä»¥ç”¨ã€‚ç¨³å®šå†…å­˜å¯ä»¥å®¹çº³é«˜è¾¾ 400 GiB çš„æ•°æ®ï¼Œå¦‚æœå­ç½‘å¯ä»¥å®¹çº³çš„è¯ã€‚</p>
<p>é€šè¿‡è¿™äº› stable å˜é‡å’Œæ˜ å°„çš„å®šä¹‰ï¼Œå¯ä»¥æŒä¹…åŒ–ä¿å­˜å¤šä¸ª Bucket çš„çŠ¶æ€ã€æ€»é‡ç­‰ä¿¡æ¯ï¼Œå¹¶åœ¨ Canister å‡çº§åç»§ç»­ä½¿ç”¨ï¼Œå®ç°äº† Bucket ç®¡ç†çš„æŒä¹…åŒ–ã€‚</p>
<pre><code class="language-js">stable let T_CYCLES = 1_000_000_000_000; // æå‰å®šä¹‰å¥½1T Cyclesï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨
stable let BUCKET_MAX_POST_NUMBER: Nat = 5000; // è®°å½•æ¯ä¸ªBucketå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¸–å­æ•°
stable var bucketIndex: Nat = 0; // bucketIndexè®°å½•å·²ç»åˆ›å»ºçš„Bucketæ•°é‡

// å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œä¿å­˜æ‰€æœ‰å·²ç»åˆ›å»ºçš„Bucketçš„ä¿¡æ¯
stable var bucketsEntries: [(Nat, Principal)] = [];
// bucketsæ˜¯æ ¹æ®bucketsEntriesåˆ›å»ºçš„æ˜ å°„è¡¨ï¼Œé”®æ˜¯ç´¢å¼•ï¼Œå€¼æ˜¯Bucketçš„principal
let buckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(bucketsEntries.vals(), Nat.equal, Hash.hash);

// availableBucketsEntrieså’ŒavailableBucketsç”¨äºè®°å½•å½“å‰å¯ç”¨çš„Bucket
stable var availableBucketsEntries: [(Nat, Principal)] = [];
let availableBuckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(availableBucketsEntries.vals(), Nat.equal, Hash.hash);

// unavailableBucketsEntrieså’ŒunavailableBucketsç”¨äºè®°å½•å½“å‰ä¸å¯ç”¨çš„Bucket
stable var unavailableBucketsEntries: [(Nat, Principal)] = [];
let unavailableBuckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(unavailableBucketsEntries.vals(), Nat.equal, Hash.hash);
</code></pre>
<br>
<p><code> _createBucket()</code> å‡½æ•°åˆ›å»º Canister ï¼š</p>
<p>ä½¿ç”¨ Bucket.Bucket å¯¹è±¡çš„ Bucket å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„ Bucket actor ï¼Œä¼ å…¥ Root Post Canister çš„ principalï¼ˆ ID ï¼‰ ã€commentFetchCanister å’Œ likeFetchCanister ä½œä¸ºå‚æ•°ã€‚</p>
<pre><code class="language-js">// åˆ›å»ºBucketçš„é€»è¾‘
private func _createBucket(): async Principal {
    // ç»™æ¯ä¸ªBucketæ·»åŠ 4T Cycles
    Cycles.add(4 * T_CYCLES);
    let newBucket = await Bucket.Bucket(
        Principal.fromActor(this),
        commentFetchCanister,
        likeFetchCanister
    );

    // å°†æ–°åˆ›å»ºçš„Bucketçš„principalä¿å­˜åˆ°bucketsæ˜ å°„è¡¨ä¸­ï¼Œé”®ä¸ºå½“å‰çš„bucketIndex
    buckets.put(bucketIndex, Principal.fromActor(newBucket));
    // åŒæ—¶ä¹Ÿä¿å­˜åˆ°availableBucketsæ˜ å°„è¡¨ä¸­ï¼Œè¡¨ç¤ºè¿™ä¸ªBucketå½“å‰å¯ç”¨
    availableBuckets.put(bucketIndex, Principal.fromActor(newBucket));

    // bucketIndexåŠ 1ï¼Œè¡¨ç¤ºå·²åˆ›å»ºBucketæ•°é‡å¢åŠ 
    bucketIndex += 1;
    
    // è¿”å›æ–°åˆ›å»ºçš„Bucketçš„principal
    Principal.fromActor(newBucket)
};
</code></pre>
<p>è¿™æ · <code>_createBucket()</code> å‡½æ•°å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ Bucket Actor ï¼Œå¹¶ä¿å­˜å®ƒçš„ principal åˆ°ä¸¤ä¸ªæ˜ å°„è¡¨ä¸­è¡¨ç¤ºå·²åˆ›å»ºå’Œå¯ç”¨çŠ¶æ€ã€‚</p>
<p>å®ƒå°è£…äº†åˆ›å»º Bucket çš„å…·ä½“é€»è¾‘ï¼Œä½œä¸ºä¸€ä¸ªç§æœ‰å‡½æ•°è¢« <code>createBucket()</code> å…¬å¼€å‡½æ•°è°ƒç”¨ã€‚ä½¿ç”¨ <code>bucketIndex</code> æ ‡è¯†æ¯ä¸ª Bucketï¼Œå¹¶åœ¨åˆ›å»ºåå¢åŠ è¯¥ç´¢å¼•ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°æ‰¹é‡åˆ›å»º Bucket ï¼Œå¹¶æ˜ç¡®å…¶çŠ¶æ€ï¼Œä¹Ÿä¸ºç®¡ç†å¤šä¸ª Bucket æä¾›äº†ä¾¿åˆ©ã€‚</p>
<br>
<p>æ¥ä¸‹æ¥ç»§ç»­æ„å»ºåˆ›å»ºå’Œç®¡ç†å¤šä¸ª Bucket çš„å‡½æ•°ã€‚</p>
<pre><code class="language-js">// å¼€å§‹å…ˆåˆ›å»º5ä¸ªBucketï¼Œå¹¶æŠŠå®ƒä»¬æ·»åŠ åˆ°bucketså’ŒavailableBucketsçš„æ˜ å°„è¡¨ä¸­
public shared({caller}) func init(): async () {
    var i = 0;
    label l loop {
        if(i &gt;= 5) break l;

        Cycles.add(4 * T_CYCLES);
        let newBucket = await Bucket.Bucket(
            Principal.fromActor(this),
            commentFetchCanister,
            likeFetchCanister
        );

        buckets.put(bucketIndex, Principal.fromActor(newBucket));
        availableBuckets.put(bucketIndex, Principal.fromActor(newBucket));
        bucketIndex += 1;

        i += 1;
    };
};

// æ‰¹é‡æ·»åŠ å·²ç»åˆ›å»ºå¥½çš„Bucketåˆ°bucketså’ŒavailableBucketsä¸­
public shared({caller}) func addAvailBucket(bucketArray: [Principal]): async () {
    for(_bucket in bucketArray.vals()) {
        buckets.put(bucketIndex, _bucket);
        availableBuckets.put(bucketIndex, _bucket);
        bucketIndex += 1;
    };
};

// è¿”å›å½“å‰å·²ç»åˆ›å»ºçš„Bucketæ•°é‡
public query func getBucketIndex(): async Nat { bucketIndex };

// å…¬å¼€åˆ›å»ºBucketçš„å‡½æ•°ï¼Œå†…éƒ¨è°ƒç”¨_createBucket()
public shared({caller}) func createBucket(): async Principal {
    await _createBucket()
};
</code></pre>
<p>ç°åœ¨æˆ‘ä»¬çš„ä¸€ä¸ª Canister å¯ä»¥ç®¡ç† Bucket çš„åˆ›å»ºã€æ·»åŠ äº†ã€‚æ‰€æœ‰ Bucket çš„åˆ›å»ºå’Œç”Ÿå‘½å‘¨æœŸèƒ½å¤Ÿè¢«é›†ä¸­ç®¡ç†ã€‚</p>
<br>
<p>ä¹‹åè¿˜è¦å†™å‡ºæŸ¥è¯¢å‡½æ•°ï¼š</p>
<pre><code class="language-js">// æŸ¥è¯¢å¯ç”¨çš„Bucket
public query func getAvailableBucket(): async ?Principal {
    if(availableBuckets.size() == 0) return null;
    availableBuckets.get(Nat.rem(Option.unwrap(Nat.fromText(Int.toText(Time.now()))), availableBuckets.size()))
};

// æŸ¥è¯¢æ‰€æœ‰çš„Bucket
public query func getAllBuckets(): async [Principal] {
    Iter.toArray(buckets.vals())
};

// æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„Bucket
public query func getAllAvailableBuckets(): async [Principal] {
    Iter.toArray(availableBuckets.vals())
};

// æŸ¥è¯¢å·²ç»å­˜æ»¡çš„Bucket
public query func getAllUnavailableBuckets(): async [Principal] {
    Iter.toArray(unavailableBuckets.vals())
};
</code></pre>
<br>
<p>åœ¨åˆ›å»º Bucket æ—¶ï¼Œæˆ‘ä»¬è¿˜å¾—å‘Šè¯‰ Bucket ç³»ç»Ÿä¸­çš„ Comment Fetch å’Œ Like Fetch çš„ Canister ID ï¼Œæ‰€ä»¥åœ¨ Root Post ä¸­ï¼Œæˆ‘ä»¬è¿˜è¦è®°å½•ã€ä¿å­˜ Comment Fetch å’Œ Like Fetch ï¼š</p>
<pre><code class="language-js">// æŒä¹…åŒ–ä¿å­˜commentFetch canisterçš„principal id
stable var commentFetchCanister = _commentFetchCanister;

// å¤–éƒ¨å¯ä»¥æŸ¥è¯¢å½“å‰ä¿å­˜çš„commentFetch canister id
public query func getCommentFetchCanister(): async Principal { commentFetchCanister };

// æˆæƒç‰¹å®šçš„calleræ›´æ–°ä¿å­˜çš„commentFetch canister id
public shared({caller}) func updateCommentFetchCanister(
    newCommentFetchCanister: Principal
): async () {
    commentFetchCanister := commentFetchCanister;
};
</code></pre>
<p>ç°åœ¨ likeFetch canister çš„ principal ID å¯ä»¥è¢«æŒä¹…åŒ–ä¿å­˜ï¼Œå¹¶å¯ä»¥é€šè¿‡ update å‡½æ•°çµæ´»æ›´æ–°ï¼Œè¿˜èƒ½è¢«å¤–éƒ¨ç¨‹åºè¯»å–æŸ¥è¯¢ã€‚</p>
<pre><code class="language-js">// æŒä¹…åŒ–ä¿å­˜likeFetch canisterçš„principal id
stable var likeFetchCanister = _likeFetchCanister;
    
// å¤–éƒ¨å¯ä»¥æŸ¥è¯¢å½“å‰ä¿å­˜çš„likeFetch canister id
public query func getLikeFetchCanister(): async Principal { likeFetchCanister };

// æˆæƒç‰¹å®šçš„calleræ›´æ–°ä¿å­˜çš„likeFetch canister id
public shared({caller}) func updateLikeFetchCanister(
    newLikeFetchCanister: Principal
): async () {
    likeFetchCanister := newLikeFetchCanister;
};
</code></pre>
<br>
<p>æœ€åæ˜¯ä¸¤ä¸ªç³»ç»Ÿå‡½æ•° <code>preupgrade()</code> å’Œ <code>postupgrade()</code> ï¼Œç”¨æ¥åœ¨ Canister å‡çº§å‰åä¿å­˜å’Œé‡ç½® buckets ã€availableBuckets å’Œ unavailableBuckets çš„ entries ã€‚</p>
<pre><code class="language-js">system func preupgrade() {
    bucketsEntries := Iter.toArray(buckets.entries());
    availableBucketsEntries := Iter.toArray(availableBuckets.entries());
    unavailableBucketsEntries := Iter.toArray(unavailableBuckets.entries());
};

system func postupgrade() {
    bucketsEntries := [];
    availableBucketsEntries := [];
    unavailableBucketsEntries := [];
};
</code></pre>
<p><code>preupgrade()</code> å‡½æ•°åœ¨ Canister å‡çº§å‰è¢«è°ƒç”¨ï¼Œå®ƒå°† buckets ã€availableBuckets å’Œ unavailableBuckets ä¸­çš„æ‰€æœ‰ entries ä¿å­˜åˆ°å¯¹åº”çš„æ•°ç»„ bucketsEntries ã€availableBucketsEntries å’Œ unavailableBucketsEntries ä¸­ã€‚</p>
<p><code>postupgrade()</code> å‡½æ•°åœ¨ Canister å‡çº§åè¢«è°ƒç”¨ï¼Œå®ƒå°† bucketsEntries ã€availableBucketsEntries å’Œ unavailableBucketsEntries æ•°ç»„æ¸…ç©ºï¼Œç›¸å½“äºé‡ç½®äº† buckets ã€availableBuckets å’Œ unavailableBuckets ä¸­çš„æ•°æ®ã€‚</p>
<p>è¿™æ ·ï¼Œé€šè¿‡åœ¨å‡çº§å‰åä¿å­˜å’Œé‡ç½® entries ï¼Œå¯ä»¥ä½¿ buckets ã€availableBuckets å’Œ unavailableBuckets ä¸­çš„æ•°æ®åœ¨ Canister å‡çº§åä¸ä¸¢å¤±ã€‚</p>
<p><code>preupgrade</code> å’Œ <code>postupgrade</code> è¢«å®šä¹‰ä¸ºç³»ç»Ÿå‡½æ•°ï¼Œä¼šç”± Runtime è‡ªåŠ¨è°ƒç”¨ï¼Œå¼€å‘è€…ä¸éœ€è¦è‡ªå·±è°ƒç”¨ã€‚</p>
<p>è¿™æ®µä»£ç å®ç°äº† Canister å‡çº§çš„æ•°æ®è¿ç§»ï¼Œé€šè¿‡åœ¨å‡çº§å‰åä¿å­˜å’Œé‡ç½®çŠ¶æ€ï¼Œä¿è¯äº† Canister å‡çº§çš„é€æ˜æ€§ã€‚</p>
<br>
<div class="center-image">
<img src="assets/5.Postæ¨¡å—/image-20240130131002611.png" alt="image-20240130131002611" style="zoom:39%;" />
</div>
<p>ä»¥ä¸‹æ˜¯ rootPost.mo çš„å®Œæ•´æ–‡ä»¶ï¼š</p>
<pre><code class="language-js">import Hash &quot;mo:base/Hash&quot;;
import Nat &quot;mo:base/Nat&quot;;
import TrieMap &quot;mo:base/TrieMap&quot;;
import Principal &quot;mo:base/Principal&quot;;
import Types &quot;./types&quot;;
import Bucket &quot;./bucket&quot;;
import Iter &quot;mo:base/Iter&quot;;
import Cycles &quot;mo:base/ExperimentalCycles&quot;;
import Time &quot;mo:base/Time&quot;;
import Int &quot;mo:base/Int&quot;;
import Option &quot;mo:base/Option&quot;;
import IC &quot;mo:ic&quot;;

actor class RootPost(
    _commentFetchCanister: Principal,
    _likeFetchCanister: Principal
) = this {

    stable let T_CYCLES = 1_000_000_000_000;
    stable let BUCKET_MAX_POST_NUMBER: Nat = 5000; // æ¯ä¸ªBucketå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¸–å­æ•°
    stable var bucketIndex: Nat = 0;

    stable var bucketsEntries: [(Nat, Principal)] = [];
    let buckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(bucketsEntries.vals(), Nat.equal, Hash.hash);

    stable var availableBucketsEntries: [(Nat, Principal)] = [];
    let availableBuckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(availableBucketsEntries.vals(), Nat.equal, Hash.hash);

    stable var unavailableBucketsEntries: [(Nat, Principal)] = [];
    let unavailableBuckets = TrieMap.fromEntries&lt;Nat, Principal&gt;(unavailableBucketsEntries.vals(), Nat.equal, Hash.hash);

    // å¼€å§‹å…ˆåˆ›å»º 5 ä¸ª Bucket
    public shared({caller}) func init(): async () {
        var i = 0;
        label l loop {
            if(i &gt;= 5) break l;

            Cycles.add(4 * T_CYCLES);
            let newBucket = await Bucket.Bucket(
                Principal.fromActor(this),
                commentFetchCanister,
                likeFetchCanister
            );

            buckets.put(bucketIndex, Principal.fromActor(newBucket));
            availableBuckets.put(bucketIndex, Principal.fromActor(newBucket));
            bucketIndex += 1;

            i += 1;
        };
    };

    public shared({caller}) func addAvailBucket(bucketArray: [Principal]): async () {
        for(_bucket in bucketArray.vals()) {
            buckets.put(bucketIndex, _bucket);
            availableBuckets.put(bucketIndex, _bucket);
            bucketIndex += 1;
        };
    };

    public query func getBucketIndex(): async Nat { bucketIndex };

    // åˆ›å»ºBucket
    public shared({caller}) func createBucket(): async Principal {
        await _createBucket()
    };

    // åˆ›å»ºBucketçš„é€»è¾‘
    private func _createBucket(): async Principal {
        Cycles.add(4 * T_CYCLES);
        let newBucket = await Bucket.Bucket(
            Principal.fromActor(this),
            commentFetchCanister,
            likeFetchCanister
        );

        buckets.put(bucketIndex, Principal.fromActor(newBucket));
        availableBuckets.put(bucketIndex, Principal.fromActor(newBucket));

        bucketIndex += 1;

        Principal.fromActor(newBucket)
    };

    public shared({caller}) func reCreateBucket(): async () {
        for((_key, _bucket) in availableBuckets.entries()) {
            if(_bucket == caller) {
                ignore await _createBucket();
                availableBuckets.delete(_key);
                unavailableBuckets.put(_key, _bucket);
            };
        };
    };

    // æŸ¥è¯¢å¯ç”¨çš„Bucket
    public query func getAvailableBucket(): async ?Principal {
        if(availableBuckets.size() == 0) return null;
        availableBuckets.get(Nat.rem(Option.unwrap(Nat.fromText(Int.toText(Time.now()))), availableBuckets.size()))
    };

    // æŸ¥è¯¢æ‰€æœ‰çš„Bucket
    public query func getAllBuckets(): async [Principal] {
        Iter.toArray(buckets.vals())
    };

    public query func getAllAvailableBuckets(): async [Principal] {
        Iter.toArray(availableBuckets.vals())
    };

    // æŸ¥è¯¢å·²ç»å­˜æ»¡çš„Bucket
    public query func getAllUnavailableBuckets(): async [Principal] {
        Iter.toArray(unavailableBuckets.vals())
    };

// ==================== CommentFetchCanister ====================

    stable var commentFetchCanister = _commentFetchCanister;
    
    public query func getCommentFetchCanister(): async Principal { commentFetchCanister };

    public shared({caller}) func updateCommentFetchCanister(
        newCommentFetchCanister: Principal
    ): async () {
        commentFetchCanister := commentFetchCanister;
    };


// ==================== LikeFetchCanister ====================

    stable var likeFetchCanister = _likeFetchCanister;
    
    public query func getLikeFetchCanister(): async Principal { likeFetchCanister };

    public shared({caller}) func updateLikeFetchCanister(
        newLikeFetchCanister: Principal
    ): async () {
        likeFetchCanister := newLikeFetchCanister;
    };

    system func preupgrade() {
        bucketsEntries := Iter.toArray(buckets.entries());
        availableBucketsEntries := Iter.toArray(availableBuckets.entries());
        unavailableBucketsEntries := Iter.toArray(unavailableBuckets.entries());
    };

    system func postupgrade() {
        bucketsEntries := [];
        availableBucketsEntries := [];
        unavailableBucketsEntries := [];
    };
}
</code></pre>
<br>
<h3 id="å­˜å‚¨å¸–å­bucketmo"><a class="header" href="#å­˜å‚¨å¸–å­bucketmo">å­˜å‚¨å¸–å­ï¼šbucket.mo</a></h3>
<p>Bucket æ˜¯å­˜å‚¨å¸–å­çš„ Canister ï¼Œæ¯ä¸ª Bucket å¯ä»¥å­˜å‚¨ä¸€å®šæ•°é‡çš„å¸–å­ã€‚æ”¯æŒå­˜å‚¨ã€æŸ¥è¯¢ã€æ›´æ–°å¸–å­ä»¥åŠé€šçŸ¥ Fetch Canister çš„åŠŸèƒ½ã€‚</p>
<p>Bucket éœ€è¦æä¾›äº†æŸ¥è¯¢å¸–å­æ•°é‡ã€æ ¹æ®å¸–å­ ID æŸ¥è¯¢å•ä¸ªå¸–å­ã€æŸ¥è¯¢å¤šä¸ªå¸–å­ã€è·å–æœ€æ–°å¸–å­çš„å‡½æ•°ã€‚</p>
<p>åœ¨æ”¶åˆ°æ–°è¯„è®ºã€ç‚¹èµä¹‹åï¼ŒBucket è¿˜è¦é€šè¿‡ Comment Fetch Canister å’Œ Like Fetch Canister ã€‚</p>
<p>å½“ Bucket å­˜å‚¨çš„å¸–å­æ•°é‡æ¥è¿‘é˜ˆå€¼æ—¶ï¼ŒRoot Post ä¼šåˆ›å»ºæ–°çš„ Bucket ã€‚</p>
<br>
<p>è¿™æ˜¯ <code>Bucket</code> æ¨¡å—çš„å¼€å§‹ï¼Œå®ƒæ˜¯å®é™…å­˜å‚¨å¸–å­çš„åœ°æ–¹ã€‚å¸¦æœ‰ <code>actor class</code> å…³é”®å­—çš„è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨çš„ Actor ç±»ã€‚å¸¦æœ‰ <code>(rootPostCanister, _commentFetchCanister, _likeFetchCanister)</code> å‚æ•°è¡¨ç¤ºè¿™ä¸ª Actor ç±»éœ€è¦åˆå§‹åŒ–æ—¶ä¼ å…¥è¿™ä¸‰ä¸ª Canister çš„ ID ã€‚</p>
<pre><code class="language-js">actor class Bucket(
    rootPostCanister: Principal,
    _commentFetchCanister: Principal,
    _likeFetchCanister: Principal
) = this {
    // ...
};
</code></pre>
<br>
<p>æ•´ä½“ä¸Šè¿™ä¸ª Bucket ç”¨äºæ¥æ”¶å„ç§æ“ä½œï¼ˆæ–°è¯„è®ºã€ç‚¹èµç­‰ï¼‰æ¥æ›´æ–°å¸–å­ï¼Œæ‰€æœ‰æ•°æ®ä»¥ä¸å¯å˜å½¢å¼å­˜å‚¨ï¼Œå¯ä»¥é«˜æ•ˆåœ°è¿›è¡ŒæŸ¥è¯¢å’Œå…±äº«ã€‚</p>
<p>é¦–å…ˆå®šä¹‰ä¸€äº›ç±»å‹ã€å˜é‡å’Œæ•°æ®ç»“æ„ã€‚</p>
<pre><code class="language-js">// å®šä¹‰äº†å‡ ä¸ªç±»å‹åˆ«å
type FeedActor = Types.FeedActor;
type PostImmutable = Types.PostImmutable;
type NewComment = Types.NewComment;
type NewLike = Types.NewLike;
type NewRepost = Types.NewRepost;
type CommentFetchActor = Types.CommentFetchActor;
type LikeFetchActor = Types.LikeFetchActor;
type RootPostActor = Types.RootPostActor;

stable let BUCKET_MAX_POST_NUMBER: Nat = 5000; // æ¯ä¸ªBucketå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¸–å­æ•°
stable let FLOOR_BUCKET_MAX_POST_NUMBER: Nat = BUCKET_MAX_POST_NUMBER - 50; // ä¸€ä¸ªä¸‹é™é˜ˆå€¼

stable let installer = msg.caller;

// postId -&gt; PostImmutable
// ä¸»è¦çš„æ•°æ®å­˜å‚¨åœ¨feedMapä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªä»å¸–å­IDåˆ°PostImmutableçš„æ˜ å°„
stable var feedMapEntries: [(Text, PostImmutable)] = [];
// å­˜å‚¨åœ¨TrieMapä¸­ï¼Œä½¿ç”¨Textå“ˆå¸Œå’Œæ¯”è¾ƒ
let feedMap = TrieMap.fromEntries&lt;Text, PostImmutable&gt;(feedMapEntries.vals(), Text.equal, Text.hash);
</code></pre>
<p><code>TrieMap</code> æ˜¯ä¸€ç§é«˜æ•ˆçš„é”®å€¼å­˜å‚¨ç»“æ„ã€‚ä½¿ç”¨ <code>TrieMap</code> ç»´æŠ¤äº†å¸–å­ä¿¡æ¯ï¼Œæä¾›äº†å­˜å‚¨ã€æ‰¹é‡å­˜å‚¨ã€æ›´æ–°è¯„è®ºã€æ›´æ–°ç‚¹èµã€æ›´æ–°è½¬å‘ç­‰åŠŸèƒ½ã€‚<code>feedMapEntries</code> å’Œ <code>feedMap</code> çš„å®šä¹‰ç”¨æ¥å­˜å‚¨å¸–å­æ•°æ®ï¼Œä¸€ä¸ªæ˜¯æ•°ç»„å½¢å¼ï¼Œä¸€ä¸ªæ˜¯ TrieMap å½¢å¼ã€‚</p>
<br>
<p>å­˜å‚¨å¸–å­ï¼š</p>
<p><code>storeFeed()</code> å‡½æ•°ç”¨æ¥å­˜å‚¨å•ä¸ªå¸–å­ã€‚å®ƒæ˜¯ <code>public shared</code> çš„ï¼Œæ‰€ä»¥å¯ä»¥è¢«å¤–éƒ¨è°ƒç”¨è€…è°ƒç”¨ã€‚</p>
<pre><code class="language-js">public shared({caller}) func storeFeed(post: PostImmutable): async Bool {
    ignore checkBucketMemory();
    _storeFeed(post);
};
</code></pre>
<p><code>batchStoreFeed()</code> ç”¨äºæ‰¹é‡å­˜å‚¨å¤šç¯‡å¸–å­ï¼Œå†…éƒ¨ä½¿ç”¨å¾ªç¯è°ƒç”¨ <code>_storeFeed()</code> é€ä¸ªå­˜å‚¨ã€‚</p>
<pre><code class="language-js">public shared({caller}) func batchStoreFeed(posts: [PostImmutable]): async () {
    for(post in posts.vals()) {
        ignore _storeFeed(post);
    };
};
</code></pre>
<p><code>updatePostRepost()</code> ç”¨æ¥æ›´æ–°ä¸€ä¸ªå¸–å­çš„è½¬å‘ä¿¡æ¯ã€‚å®ƒä¼šè°ƒç”¨ <code>_updatePostRepost()</code> æ‰§è¡Œå®é™…çš„æ›´æ–°ï¼Œå¹¶ assert ç¡®ä¿æ›´æ–°æˆåŠŸã€‚</p>
<pre><code class="language-js">public shared({caller}) func updatePostRepost(postId: Text, newRepost: NewRepost): async Bool {
    assert(_updatePostRepost(postId, newRepost));
    true
};
</code></pre>
<p><code>_storeFeed()</code> å’Œ <code>_updatePostRepost()</code> æ˜¯ç§æœ‰å‡½æ•°ï¼Œæ˜¯å®é™…å®ç°å­˜å‚¨å’Œæ›´æ–°çš„å†…éƒ¨é€»è¾‘ã€‚</p>
<br>
<p>æ¥ä¸‹æ¥æ˜¯æ›´æ–°å¸–å­è¯„è®ºå’Œç‚¹èµçš„åŠŸèƒ½ï¼š</p>
<p><code>updatePostComment</code> å‡½æ•°ç”¨äºæ›´æ–°å¸–å­çš„è¯„è®ºä¿¡æ¯ã€‚å®ƒæ¥æ”¶å¸–å­ ID å’Œæ–°çš„è¯„è®ºä½œä¸ºå‚æ•°ã€‚å†…éƒ¨è°ƒç”¨ <code>_updatePostComment</code> å‡½æ•°å»å®é™…æ‰§è¡Œè¯„è®ºçš„æ›´æ–°ã€‚</p>
<p>æ›´æ–°æˆåŠŸåï¼Œä¼šä» <code>_updatePostComment</code> è¿”å›æ›´æ–°åçš„ post å¯¹è±¡ã€‚ç„¶åé€šçŸ¥ <code>CommentFetchActor</code> å»æ›´æ–°è¯„è®ºç¼“å­˜ã€‚</p>
<p><code>updatePostLike</code> å‡½æ•°ç”¨äºæ›´æ–°å¸–å­çš„ç‚¹èµä¿¡æ¯ã€‚å®ƒæ¥æ”¶å¸–å­ ID å’Œæ–°çš„ç‚¹èµä½œä¸ºå‚æ•°ã€‚å†…éƒ¨è°ƒç”¨ <code>_updatePostLike</code> å»å®é™…æ‰§è¡Œç‚¹èµçš„æ›´æ–°ã€‚ </p>
<p>æ›´æ–°æˆåŠŸåï¼ŒåŒæ ·è¿”å›æ›´æ–°åçš„ post å¯¹è±¡ï¼Œå¹¶é€šçŸ¥ <code>LikeFetchActor</code> å»æ›´æ–°ç‚¹èµç¼“å­˜ã€‚</p>
<pre><code class="language-js">// æ›´æ–°å¸–å­è¯„è®ºä¿¡æ¯
// callerå‚æ•°è¡¨ç¤ºï¼šåªæœ‰è°ƒç”¨è€…çš„è¯·æ±‚ä¸­ç»™å‡ºæ­£å¸¸èº«ä»½ï¼Œæ‰èƒ½è°ƒç”¨å‡½æ•°
public shared({caller}) func updatePostComment(postId: Text, newComment: NewComment): async Bool {
    switch(_updatePostComment(postId, newComment)) {
        case(null) { return false; };
        case(?_post) {
            // é€šçŸ¥ commentFetch
            let commentFetchActor: CommentFetchActor = actor(Principal.toText(commentFetchCanister));
            ignore commentFetchActor.receiveNotify(_post);
        };
    };
    // è¿”å›Boolå€¼è¡¨ç¤ºæ›´æ–°æ˜¯å¦æˆåŠŸ
    true
};

public shared({caller}) func updatePostLike(postId: Text, newLike: NewLike): async Bool {
    switch(_updatePostLike(postId, newLike)) {
        case(null) { return false; };
        case(?_post) {
            // é€šçŸ¥ likeFetch
            let likeFetchActor: LikeFetchActor = actor(Principal.toText(likeFetchCanister));
            ignore likeFetchActor.receiveNotify(_post);
        };     
    };
    true
};
</code></pre>
<p>æˆ‘ä»¬é€šè¿‡ç§æœ‰å‡½æ•°å®ç°å¯¹æ“ä½œå¸–å­å‡½æ•°çš„å°è£…ã€‚å¤–éƒ¨åªéœ€è¦è°ƒç”¨å…¬å¼€çš„ update å‡½æ•°ï¼Œä¸éœ€è¦å…³å¿ƒå†…éƒ¨çš„å­˜å‚¨å’Œæ›´æ–°é€»è¾‘ã€‚ ç§æœ‰å‡½æ•°å¯ä»¥å°è£…çŠ¶æ€ç®¡ç†ï¼Œä½¿ä»£ç æ›´åŠ æ¨¡å—åŒ–å’Œå¯ç»´æŠ¤ã€‚</p>
<br>
<p><code>_updatePostComment</code> å‡½æ•°ç”¨äºæ›´æ–°å¸–å­çš„è¯„è®ºã€‚å®ƒä» <code>feedMap</code> ä¸­è·å–åŸæœ‰çš„å¸–å­ï¼Œç”¨æ–°è¯„è®º <code>newComment</code> æ›´æ–° <code>comment</code> å­—æ®µï¼Œå¹¶ put å›<code>feedMap</code> ã€‚</p>
<p><code>feedMap</code> æ˜¯ä¸€ä¸ªå­˜å‚¨å¸–å­çš„å“ˆå¸Œè¡¨ï¼Œkey æ˜¯ <code>postId</code> ï¼Œvalue æ˜¯ <code>PostImmutable</code> è®°å½•ã€‚</p>
<pre><code class="language-js">private func _updatePostComment(postId: Text, newComment: NewComment): ?PostImmutable {
    switch(feedMap.get(postId)) {
        case(null) { return null; };
        case(?post) {
            let _newPost = {
                postId = post.postId;
                feedCanister = post.feedCanister;
                index = post.index;
                user = post.user;
                repost = post.repost;
                content = post.content;
                like = post.like;
                comment = newComment;
                createdAt = post.createdAt;
            };
            feedMap.put(postId, _newPost);
            ?_newPost
        };
    };
};
</code></pre>
<br>
<p><code>_updatePostLike</code> ç±»ä¼¼åœ°æ›´æ–°å¸–å­çš„ç‚¹èµ like å­—æ®µã€‚ </p>
<pre><code class="language-js">private func _updatePostLike(postId: Text, newLike: NewLike): ?PostImmutable {
    switch(feedMap.get(postId)) {
        case(null) { return null; };
        case(?post) {
            let _newPost = {
                postId = post.postId;
                feedCanister = post.feedCanister;
                index = post.index;
                user = post.user;
                repost = post.repost;
                content = post.content;
                like = newLike;
                comment = post.comment;
                createdAt = post.createdAt;
            };
            feedMap.put(postId, _newPost);
            ?_newPost              
        };
    };
};
</code></pre>
<br>
<p><code>_updatePostRepost</code> æ›´æ–°å¸–å­çš„è½¬å‘ repost å­—æ®µã€‚</p>
<pre><code class="language-js">private func _updatePostRepost(postId: Text, newRepost: NewRepost): Bool {
    switch(feedMap.get(postId)) {
        case(null) { return false; };
        case(?post) {
            feedMap.put(postId, {
                postId = post.postId;
                feedCanister = post.feedCanister;
                index = post.index;
                user = post.user;
                content = post.content;
                repost = newRepost;
                like = post.like;
                comment = post.comment;
                createdAt = post.createdAt;
            });
            true
        };
    };
};
</code></pre>
<br>
<p>ä½¿ç”¨ <code>immutable</code> æ•°æ®ç»“æ„ <code>PostImmutable</code> å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…æ„å¤–ä¿®æ”¹ã€‚</p>
<pre><code class="language-js">// æŠŠæ–°çš„å¸–å­ä¿å­˜åˆ°feedMapä¸­
// æ£€æŸ¥postIdæ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨æ‰ä¿å­˜ï¼Œé¿å…é‡å¤
private func _storeFeed(post: PostImmutable): Bool {
    ignore Utils.checkPostId(post.postId);
    switch(feedMap.get(post.postId)) {
        case(?_post) {
            // Debug.print(&quot;This post has been stored&quot;);
            return false;
        };
        case(null) {
            feedMap.put(post.postId, post);
            return true;
        };
    };
};
</code></pre>
<br>
<p><code>checkBucketMemory</code> å‡½æ•°ç”¨äºæ£€æŸ¥å½“å‰ Bucket æ˜¯å¦æ¥è¿‘å®¹é‡ä¸Šé™ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™é€šçŸ¥æ ¹å¸–å­ Actor åˆ›å»ºæ–°çš„ Bucket ã€‚</p>
<pre><code class="language-js">func checkBucketMemory(): async () {
    if(feedMap.size() &gt; FLOOR_BUCKET_MAX_POST_NUMBER) {
        let rootPostActor: RootPostActor = actor(Principal.toText(rootPostCanister));
        ignore rootPostActor.reCreateBucket();
    }
};
</code></pre>
<br>
<p>æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæŸ¥è¯¢å¸–å­æ€»æ•°çš„å‡½æ•°ï¼š</p>
<pre><code class="language-js">// æŸ¥è¯¢å…±æœ‰å¤šå°‘ä¸ªå¸–å­
public query func getPostNumber(): async Nat {
    feedMap.size()
};
</code></pre>
<br>
<p>è¿˜æœ‰è·å–å¸–å­å…·ä½“å†…å®¹çš„å‡½æ•°ï¼Œå®ç°å¿«é€Ÿæ‰¹é‡è·å–æŸå‡ ä¸ªå¸–å­çš„åŠŸèƒ½ã€‚</p>
<p>è¿™ä¸ªåŠŸèƒ½ç”¨åœ¨ Feed Canister æŠ“å–å¸–å­ä¸Šï¼š</p>
<p>å½“ç”¨æˆ·å…³æ³¨çš„æŸå‡ ä¸ªäººå‘å¸ƒäº†å¸–å­ï¼Œè¿™äº›å¸–å­çš„ ID åˆä¼šè¢«é€åˆ° Fetch ï¼Œæœ€åå‘é€åˆ° å¦ä¸€ä¸ª Feed é‡Œã€‚è¿™æ˜¯ Feed å°±ä¼šä¸€æ¬¡æ€§æ”¶åˆ°å¾ˆå¤šä¸ªå¸–å­çš„ ID ï¼ŒFeed å°±éœ€è¦æŠŠè¿™äº›å¸–å­ ID å‘ç»™ Bucket ï¼Œä¸€æ¬¡æ€§è·å–åˆ°è¿™äº›å¸–å­ä»¬ã€‚</p>
<pre><code class="language-js">// æ ¹æ®IDæŸ¥è¯¢æŸå‡ ä¸ªå¸–å­ï¼ˆå¯ä»¥ä¼ å…¥7ä¸ªIDä¸€æ¬¡æ€§è¿”å›7ä¸ªå¸–å­çš„å†…å®¹ï¼‰
public query func getPosts(postIdArray: [Text]): async [PostImmutable] { // æ¥æ”¶ä¸€ä¸ªTextæ•°ç»„postIdArrayä½œä¸ºå‚æ•°
    // åˆ›å»ºä¸€ä¸ªBufferæ¥å­˜å‚¨æŸ¥è¯¢ç»“æœï¼Œå¤§å°ä¸ºpostIdArrayçš„å¤§å°
    let result = Buffer.Buffer&lt;PostImmutable&gt;(postIdArray.size());
    // éå†postIdArrayä¸­çš„æ¯ä¸ªID
    for(postId in postIdArray.vals()) {
        // å¯¹æ¯ä¸ªIDï¼Œä»feedMapä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°åˆ™æ”¾å…¥ç»“æœBufferä¸­
        switch(feedMap.get(postId)) {
            case(null) {};
            case(?post) { result.add(post); };
        };
    };
        // éå†ç»“æŸåï¼Œé€šè¿‡toArray()è½¬æ¢Bufferä¸ºæ•°ç»„å¹¶è¿”å›
        Buffer.toArray&lt;PostImmutable&gt;(result)
};
</code></pre>
<p>æˆ‘ä»¬ä½¿ç”¨ Buffer é¿å…å¤šæ¬¡æ•°ç»„æ‹¼æ¥çš„å¼€é”€ã€‚query å‡½æ•°å¯ä»¥è¢«é“¾å¤–è°ƒç”¨ï¼Œå®ç°äº†æ•°æ®æŸ¥è¯¢çš„å°è£…ã€‚ è¿”å›çš„æ˜¯æ•°ç»„ç±»å‹ï¼Œè°ƒç”¨æ–¹å¯ä»¥æ–¹ä¾¿å¤„ç†æŸ¥è¯¢ç»“æœã€‚</p>
<p>è¿™æ ·å°±å¯ä»¥æ‰¹é‡æŸ¥è¯¢å¤šç¯‡å¸–å­å†…å®¹äº†ã€‚</p>
<br>
<p>æ ¹æ® ID æ‰¹é‡ç²¾ç¡®æŸ¥è¯¢å¸–å­ä¹‹åï¼Œè¿˜éœ€è¦ 2 ä¸ªå…³äºæŸ¥è¯¢çš„å‡½æ•°ï¼šæ ¹æ® ID å•ç‹¬æŸ¥è¯¢å¸–å­çš„å‡½æ•°å’ŒæŸ¥è¯¢æœ€æ–°çš„ n ä¸ªå¸–å­å‡½æ•°ã€‚</p>
<pre><code class="language-js">public query func getPost(postId: Text): async ?PostImmutable {
    switch(feedMap.get(postId)) {
        case(null) { return null; };
        case(?post) { return ?post; }; 
    };
};

// æŸ¥è¯¢æœ€æ–°çš„ n ä¸ªå¸–å­
public query func getLatestFeed(n: Nat): async [PostImmutable] {
    let feedArray = Iter.toArray(
        Iter.sort&lt;PostImmutable&gt;(
        feedMap.vals(),
        func (x: PostImmutable, y: PostImmutable): Order.Order {
            if(x.createdAt &gt; y.createdAt) return #less
            else if(x.createdAt &lt; y.createdAt) return #greater
            else return #equal
    }));
    if(n &lt;= feedArray.size()) {
        Array.subArray(feedArray, 0, n)
    } else {
        Array.subArray(feedArray, 0, feedArray.size())
    }
};
</code></pre>
<p>æœ€åæ˜¯å’Œå‡çº§æœ‰å…³çš„ç³»ç»Ÿå‡½æ•°ï¼Œé€šè¿‡ <code>preupgrade</code> å’Œ <code>postupgrade</code> å‡½æ•°ç®¡ç† Bucket çš„çŠ¶æ€ã€‚</p>
<br>
<p>ä»¥ä¸‹æ˜¯ bucket.mo å®Œæ•´æ–‡ä»¶ï¼š</p>
<pre><code class="language-js">import Types &quot;./types&quot;;
import TrieMap &quot;mo:base/TrieMap&quot;;
import Principal &quot;mo:base/Principal&quot;;
import Array &quot;mo:base/Array&quot;;
import Order &quot;mo:base/Order&quot;;
import Text &quot;mo:base/Text&quot;;
import Hash &quot;mo:base/Hash&quot;;
import Nat &quot;mo:base/Nat&quot;;
import Iter &quot;mo:base/Iter&quot;;
import Debug &quot;mo:base/Debug&quot;;
import Option &quot;mo:base/Option&quot;;
import Buffer &quot;mo:base/Buffer&quot;;
import Utils &quot;../utils&quot;;

shared(msg) actor class Bucket(
    rootPostCanister: Principal,
    _commentFetchCanister: Principal,
    _likeFetchCanister: Principal
) = this {
    
    type FeedActor = Types.FeedActor;
    type PostImmutable = Types.PostImmutable;
    type NewComment = Types.NewComment;
    type NewLike = Types.NewLike;
    type NewRepost = Types.NewRepost;
    type CommentFetchActor = Types.CommentFetchActor;
    type LikeFetchActor = Types.LikeFetchActor;
    type RootPostActor = Types.RootPostActor;

    stable let BUCKET_MAX_POST_NUMBER: Nat = 5000; // æ¯ä¸ªBucketå¯ä»¥å­˜å‚¨çš„æœ€å¤§å¸–å­æ•° (å¾…è®¡ç®—)
    stable let FLOOR_BUCKET_MAX_POST_NUMBER: Nat = BUCKET_MAX_POST_NUMBER - 50;

    stable let installer = msg.caller;

    // postId -&gt; PostImmutable
    stable var feedMapEntries: [(Text, PostImmutable)] = [];
    let feedMap = TrieMap.fromEntries&lt;Text, PostImmutable&gt;(feedMapEntries.vals(), Text.equal, Text.hash);

    // å­˜å‚¨å¸–å­
    public shared({caller}) func storeFeed(post: PostImmutable): async Bool {
        ignore checkBucketMemory();
        _storeFeed(post);
    };

    public shared({caller}) func batchStoreFeed(posts: [PostImmutable]): async () {
        for(post in posts.vals()) {
            ignore _storeFeed(post);
        };
    };

    public shared({caller}) func updatePostRepost(postId: Text, newRepost: NewRepost): async Bool {
        assert(_updatePostRepost(postId, newRepost));
        true
    };

    // æ›´æ–°å¸–å­è¯„è®ºä¿¡æ¯ 
    public shared({caller}) func updatePostComment(postId: Text, newComment: NewComment): async Bool {
        switch(_updatePostComment(postId, newComment)) {
            case(null) { return false; };
            case(?_post) {
                // é€šçŸ¥ commentFetch
                let commentFetchActor: CommentFetchActor = actor(Principal.toText(commentFetchCanister));
                ignore commentFetchActor.receiveNotify(_post);
            };
        };
        true
    };

    public shared({caller}) func updatePostLike(postId: Text, newLike: NewLike): async Bool {
        switch(_updatePostLike(postId, newLike)) {
            case(null) { return false; };
            case(?_post) {
                // é€šçŸ¥ likeFetch
                let likeFetchActor: LikeFetchActor = actor(Principal.toText(likeFetchCanister));
                ignore likeFetchActor.receiveNotify(_post);
            };     
        };
        true
    };

    func checkBucketMemory(): async () {
        if(feedMap.size() &gt; FLOOR_BUCKET_MAX_POST_NUMBER) {
            let rootPostActor: RootPostActor = actor(Principal.toText(rootPostCanister));
            ignore rootPostActor.reCreateBucket();
        }
    };

    private func _updatePostComment(postId: Text, newComment: NewComment): ?PostImmutable {
        switch(feedMap.get(postId)) {
            case(null) { return null; };
            case(?post) {
                let _newPost = {
                    postId = post.postId;
                    feedCanister = post.feedCanister;
                    index = post.index;
                    user = post.user;
                    repost = post.repost;
                    content = post.content;
                    like = post.like;
                    comment = newComment;
                    createdAt = post.createdAt;
                };
                feedMap.put(postId, _newPost);
                ?_newPost
            };
        };
    };

    private func _updatePostLike(postId: Text, newLike: NewLike): ?PostImmutable {
        switch(feedMap.get(postId)) {
            case(null) { return null; };
            case(?post) {
                let _newPost = {
                    postId = post.postId;
                    feedCanister = post.feedCanister;
                    index = post.index;
                    user = post.user;
                    repost = post.repost;
                    content = post.content;
                    like = newLike;
                    comment = post.comment;
                    createdAt = post.createdAt;
                };
                feedMap.put(postId, _newPost);
                ?_newPost              
            };
        };
    };

    private func _updatePostRepost(postId: Text, newRepost: NewRepost): Bool {
        switch(feedMap.get(postId)) {
            case(null) { return false; };
            case(?post) {
                feedMap.put(postId, {
                    postId = post.postId;
                    feedCanister = post.feedCanister;
                    index = post.index;
                    user = post.user;
                    content = post.content;
                    repost = newRepost;
                    like = post.like;
                    comment = post.comment;
                    createdAt = post.createdAt;
                });
                true              
            };
        };
    };

    private func _storeFeed(post: PostImmutable): Bool {
        ignore Utils.checkPostId(post.postId);
        switch(feedMap.get(post.postId)) {
            case(?_post) {
                // Debug.print(&quot;This post has been stored&quot;);
                return false;
            };
            case(null) {
                feedMap.put(post.postId, post);
                return true;
            };
        };
    };

// ==================== æŸ¥è¯¢å‡½æ•° ====================

    // æŸ¥è¯¢å…±æœ‰å¤šå°‘ä¸ªå¸–å­
    public query func getPostNumber(): async Nat {
        feedMap.size()
    };

    // æ ¹æ®IDæŸ¥è¯¢æŸå‡ ä¸ªå¸–å­ï¼ˆå¯ä»¥ä¼ å…¥ 7 ä¸ª ID ä¸€æ¬¡æ€§è¿”å› 7 ä¸ªå¸–å­çš„å†…å®¹ï¼‰
    public query func getPosts(postIdArray: [Text]): async [PostImmutable] {
       let result = Buffer.Buffer&lt;PostImmutable&gt;(postIdArray.size());
       for(postId in postIdArray.vals()) {
        switch(feedMap.get(postId)) {
            case(null) {};
            case(?post) { result.add(post); };
        };
       };
       Buffer.toArray&lt;PostImmutable&gt;(result)
    };

    public query func getPost(postId: Text): async ?PostImmutable {
        switch(feedMap.get(postId)) {
            case(null) { return null; };
            case(?post) { return ?post; }; 
        };
    };

    // æŸ¥è¯¢æœ€æ–°çš„ n ä¸ªå¸–å­
    public query func getLatestFeed(n: Nat): async [PostImmutable] {
        let feedArray = Iter.toArray(
            Iter.sort&lt;PostImmutable&gt;(
            feedMap.vals(),
            func (x: PostImmutable, y: PostImmutable): Order.Order {
                if(x.createdAt &gt; y.createdAt) return #less
                else if(x.createdAt &lt; y.createdAt) return #greater
                else return #equal
        }));
        if(n &lt;= feedArray.size()) {
            Array.subArray(feedArray, 0, n)
        } else {
            Array.subArray(feedArray, 0, feedArray.size())
        }
    };

// ==================== CommentFetchCanister ====================

    stable var commentFetchCanister = _commentFetchCanister;
    
    public query func getCommentFetchCanister(): async Principal { commentFetchCanister };

    public shared({caller}) func updateCommentFetchCanister(
        newCommentFetchCanister: Principal
    ): async () {
        commentFetchCanister := commentFetchCanister;
    };


// ==================== LikeFetchCanister ====================

    stable var likeFetchCanister = _likeFetchCanister;
    
    public query func getLikeFetchCanister(): async Principal { likeFetchCanister };

    public shared({caller}) func updateLikeFetchCanister(
        newLikeFetchCanister: Principal
    ): async () {
        likeFetchCanister := newLikeFetchCanister;
    };

    system func preupgrade() {
        feedMapEntries := Iter.toArray(feedMap.entries());
    };

    system func postupgrade() {
        feedMapEntries := [];
    };
}
</code></pre>
<p>ç„¶åæ˜¯ <a href="./6.Feed%E6%A8%A1%E5%9D%97.html">Feed æ¨¡å—</a>ã€‚</p>

                        <div id="giscus-container"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../9.Dappå¼€å‘/4.Useræ¨¡å—.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../9.Dappå¼€å‘/6.Feedæ¨¡å—.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../9.Dappå¼€å‘/4.Useræ¨¡å—.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../9.Dappå¼€å‘/6.Feedæ¨¡å—.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
        var pagePath = "9.Dappå¼€å‘/5.Postæ¨¡å—.md"
        </script>


        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../assets/custom.js"></script>
        <script type="text/javascript" src="../assets/bigPicture.js"></script>


    </body>
</html>