<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Feedæ¨¡å— - äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The constellation book for you.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.png">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/style.css">

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

        <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML">
        </script>

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');
                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }
                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item affix "><a href="../about.html">ğŸ‘½äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—ğŸ›¸</a></li><li class="chapter-item affix "><li class="part-title">å»ä¸­å¿ƒåŒ–ä¹‹æ—…ğŸ”</li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/é€ æ¢¦å®¶çš„å†’é™©ä¹‹æ—….html">é€ æ¢¦å®¶çš„å†’é™©ä¹‹æ—…</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æœªæ¥å·²æ¥.html">æœªæ¥å·²æ¥</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/åŠ å¯†æœ‹å…‹çš„é‚£äº›äº‹.html">åŠ å¯†æœ‹å…‹çš„é‚£äº›äº‹</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/åŒºå—é“¾æ˜¯å•¥ï¼Ÿ.html">åŒºå—é“¾æ˜¯å•¥ï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/ä»€ä¹ˆæ˜¯ä»¥å¤ªåŠï¼Ÿ.html">ä»€ä¹ˆæ˜¯ä»¥å¤ªåŠï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æˆ‘çš„ç½‘ç»œéšç§å‘¢ï¼Ÿ.html">æˆ‘çš„ç½‘ç»œéšç§å‘¢ï¼Ÿ</a></li><li class="chapter-item "><a href="../0.å»ä¸­å¿ƒåŒ–ä¹‹æ—…/æ¯”ç‰¹å¸.html">æ¯”ç‰¹å¸</a></li></ol></li><li class="chapter-item "><li class="part-title">äº†è§£ICğŸ“¡</li><li class="chapter-item "><a href="../1.äº†è§£IC/1.äº†è§£IC.html">äº†è§£IC</a></li><li class="chapter-item "><a href="../1.äº†è§£IC/ICP=Web3.0.html">ICP = Web 3.0</a></li><li class="chapter-item affix "><li class="part-title">æ ¸å¿ƒåè®®â­</li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/1.P2På±‚.html">P2På±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/2.å…±è¯†å±‚.html">å…±è¯†å±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/3.æ¶ˆæ¯è·¯ç”±å±‚.html">æ¶ˆæ¯è·¯ç”±å±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/4.æ‰§è¡Œå±‚.html">æ‰§è¡Œå±‚</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/ç®€ä»‹.html">ç›¸å…³æ¦‚å¿µ</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/å…±è¯†å§”å‘˜ä¼šæ•°é‡å¦‚ä½•ç¡®å®šï¼Ÿ.html">å…±è¯†å§”å‘˜ä¼šæ•°é‡å¦‚ä½•ç¡®å®šï¼Ÿ</a></li><li class="chapter-item "><a href="../2.æ ¸å¿ƒåè®®/ç›¸å…³æ¦‚å¿µä»‹ç»/P2På±‚æ˜¯å¦‚ä½•é™ä½æ¶æ„æ”»å‡»çš„ï¼Ÿ.html">P2På±‚æ˜¯å¦‚ä½•é™ä½æ¶æ„æ”»å‡»çš„ï¼Ÿ</a></li></ol></li><li class="chapter-item "><li class="part-title">é“¾é’¥å¯†ç å­¦ğŸª„</li><li class="chapter-item "><a href="../3.é“¾é’¥å¯†ç å­¦(ChainKey)/1.ChainKey.html">Chain Key</a></li><li class="chapter-item "><a href="../3.é“¾é’¥å¯†ç å­¦(ChainKey)/VetKeys.html">VETKeys</a></li><li class="chapter-item affix "><li class="part-title">å®¹å™¨ğŸ§°</li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/1.Canister.html">Canister</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/2.Motoko.html">Motoko</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/3.éƒ¨ç½²è‡ªå·±çš„Canister.html">éƒ¨ç½²Canister</a></li><li class="chapter-item "><a href="../4.å®¹å™¨(Canister)/4.XRC.html">XRC</a></li><li class="chapter-item affix "><li class="part-title">ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)âš™ï¸</li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/1.NNS.html">NNS</a></li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/2.DAO.html">DAO</a></li><li class="chapter-item "><a href="../5.ç½‘ç»œç¥ç»ç³»ç»Ÿ(NNS)/3.ç»æµæ¨¡å‹.html">ç»æµæ¨¡å‹</a></li><li class="chapter-item affix "><li class="part-title">åŒºå—é“¾ç½‘ç»œæœåŠ¡ğŸ¯</li><li class="chapter-item "><a href="../6.åŒºå—é“¾ç½‘ç»œæœåŠ¡/5.å¯ä¿¡æ‰§è¡Œç¯å¢ƒ.html">å¯ä¿¡æ‰§è¡Œç¯å¢ƒ</a></li><li class="chapter-item "><a href="../6.åŒºå—é“¾ç½‘ç»œæœåŠ¡/6.é“¾ä¸Šéšæœºæ•°.html">é“¾ä¸Šéšæœºæ•°</a></li><li class="chapter-item affix "><li class="part-title">äº’è”ç½‘èº«ä»½ğŸ”‘</li><li class="chapter-item "><a href="../7.äº’è”ç½‘èº«ä»½/1.ii.html">äº’è”ç½‘èº«ä»½</a></li><li class="chapter-item "><a href="../7.äº’è”ç½‘èº«ä»½/3.pid.html">pid</a></li><li class="chapter-item affix "><li class="part-title">ICé‡Œçš„å¯†ç å­¦ğŸ”’</li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/åŸºç¡€å¯†ç å­¦çŸ¥è¯†.html">åŸºç¡€å¯†ç å­¦ä»‹ç»</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/BLSç­¾å.html">BLS</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/ç§˜å¯†å…±äº«.html">ç§˜å¯†å…±äº«</a></li><li class="chapter-item "><a href="../8.ICé‡Œçš„å¯†ç å­¦/å“ˆå¸Œç®—æ³•.html">å“ˆå¸Œç®—æ³•</a></li><li class="chapter-item affix "><li class="part-title">å¼€å‘DAppğŸŒŸ</li><li class="chapter-item "><a href="../9.Dappå¼€å‘/å®‰è£…å¼€å‘ç¯å¢ƒ.html">å®‰è£…å¼€å‘ç¯å¢ƒ</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/dfxå¸¸ç”¨å‘½ä»¤.html">dfxå¸¸ç”¨å‘½ä»¤</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/Motoko.html">Motoko</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/1.å…¥é—¨DApp.html">å…¥é—¨DApp</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/2.è®¾è®¡DApp.html">è®¾è®¡DApp</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/3.å¼€å‘Proton.html">å¼€å‘Proton</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/4.Useræ¨¡å—.html">Useræ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/5.Postæ¨¡å—.html">Postæ¨¡å—</a></li><li class="chapter-item expanded "><a href="../9.Dappå¼€å‘/6.Feedæ¨¡å—.html" class="active">Feedæ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/7.Fetchæ¨¡å—.html">Fetchæ¨¡å—</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/8.å…±äº«ç±»å‹.html">å…±äº«ç±»å‹</a></li><li class="chapter-item "><a href="../9.Dappå¼€å‘/9.å®Œæˆ.html">å®Œæˆ</a></li><li class="spacer"></li><li class="chapter-item affix "><a href="../è¯æ±‡è¡¨.html">è¯æ±‡è¡¨</a></li><li class="chapter-item affix "><a href="../è´¡çŒ®è€…åå•.html">è´¡çŒ®è€…åå•</a></li><li class="chapter-item affix "><a href="../å‚è€ƒèµ„æ–™.html">å‚è€ƒèµ„æ–™</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">äº’è”ç½‘è®¡ç®—æœºæ¼«æ¸¸æŒ‡å—</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/NeutronStarDAO/ConstellationBook-Chinese" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');

                    // Get viewed page store
                    var viewed_key = 'mdbook-viewed';
                    var viewed_map = {};
                    try {
                        var viewed_storage = localStorage.getItem(viewed_key);
                        if (viewed_storage) {
                            viewed_map = JSON.parse(viewed_storage)
                        }
                    } catch (e) { }

                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                        
                        // Apply viewed style
                        if (viewed_map[link.pathname]) {
                            link.classList.add('md-viewed')
                        }
                    }); 

                    // Mark viewed after 30s
                    setTimeout(function() {
                        viewed_map[location.pathname] = 1;
                        localStorage.setItem(viewed_key, JSON.stringify(viewed_map));
                    }, 30000)
                </script>

                <div id="content" class="content">
                    <!-- Page table of contents -->
                    <div class="sidetoc"><nav class="pagetoc"></nav></div>
                    <main>
                        <h2 id="feed"><a class="header" href="#feed">Feed</a></h2>
<p>åœ¨ Feed æ¨¡å—ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹å‡ ä¸ªæ–‡ä»¶ï¼š</p>
<p><strong>types.mo æ–‡ä»¶</strong></p>
<p>å®šä¹‰äº†æ•´ä¸ªç³»ç»Ÿä¸­ä½¿ç”¨çš„ä¸»è¦æ•°æ®ç±»å‹åˆ«åã€‚å®ƒå¯¼å…¥äº†ä¸€ä¸ªå« <code>Types</code> çš„æ¨¡å—ï¼Œç„¶åé‡æ–°å¯¼å‡ºè¯¥æ¨¡å—ä¸­å®šä¹‰çš„ç±»å‹ï¼Œå¦‚å¸–å­ï¼ˆPostï¼‰ã€è¯„è®ºï¼ˆCommentï¼‰ã€ç‚¹èµï¼ˆLikeï¼‰ç­‰ã€‚</p>
<p><strong>rootFeed.mo æ–‡ä»¶</strong></p>
<p>å®ƒè´Ÿè´£ç»Ÿè®¡å’Œåˆ›å»ºç”¨æˆ·çš„ Feed ã€‚</p>
<ul>
<li><code>createFeedCanister</code> å‡½æ•°å…è®¸ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„ä¿¡æ¯æµ Canisterï¼ˆå®¹å™¨ï¼‰ï¼Œè¿™æ˜¯ç”¨æˆ·åœ¨å¹³å°ä¸Šå­˜å‚¨å¸–å­å’Œä¿¡æ¯æµçš„åœ°æ–¹ã€‚</li>
<li><code>updateFetchUserToFeed</code> å‡½æ•°è´Ÿè´£åœ¨ç”¨æˆ·åˆ›å»ºæ–°çš„ä¿¡æ¯æµ Canister æ—¶æ›´æ–°å…¶ä»–ç³»ç»Ÿç»„ä»¶ï¼Œå¦‚å¸–å­ã€è¯„è®ºå’Œç‚¹èµçš„æŠ“å–æœåŠ¡ã€‚</li>
<li><code>getUserFeedCanister</code> å’Œ <code>getAllUserFeedCanister</code> å‡½æ•°æä¾›äº†æ£€ç´¢ç”¨æˆ·ä¿¡æ¯æµ Canister çš„æ–¹å¼ã€‚</li>
</ul>
<p><strong>database.mo æ–‡ä»¶</strong></p>
<p>å®ç°äº†ä¸€ä¸ªå¸–å­ç›®å½•ï¼ˆ<code>PostDirectory</code>ï¼‰å’Œä¸€ä¸ªä¿¡æ¯æµç›®å½•ï¼ˆ<code>FeedDirectory</code>ï¼‰ï¼Œå®ƒä»¬æ˜¯ç”¨äºå­˜å‚¨å’Œç®¡ç†å¸–å­åŠå…¶ç›¸å…³åŠ¨ä½œï¼ˆå¦‚è¯„è®ºã€ç‚¹èµå’Œè½¬å‘ï¼‰çš„æ•°æ®åº“ã€‚</p>
<ul>
<li><code>PostDirectory</code> ç±»ä¸­æœ‰ä¸€ä¸ª <code>postMap</code>ï¼Œå®ƒæ˜¯ä¸€ä¸ªä½¿ç”¨ <code>TrieMap</code> å®ç°çš„é”®å€¼å¯¹é›†åˆï¼Œç”¨äºå­˜å‚¨å¸–å­åŠå…¶ç´¢å¼•ã€‚</li>
<li><code>createPost</code> å‡½æ•°å®ç°äº†å‘å¸–çš„åŠŸèƒ½ã€‚å®ƒåˆ›å»ºä¸€ä¸ªæ–°å¸–å­å¹¶å°†å…¶æ·»åŠ åˆ° <code>postMap</code> ä¸­ï¼ŒåŒæ—¶å°†å¸–å­ç´¢å¼•é€’å¢ã€‚</li>
<li><code>getPost</code> å‡½æ•°å…è®¸é€šè¿‡å¸–å­ ID æ£€ç´¢å¸–å­ã€‚</li>
<li><code>createComment</code> ã€<code>createLike</code> å’Œ <code>createRepost</code> åˆ†åˆ«ç”¨äºåˆ›å»ºè¯„è®ºã€ç‚¹èµå’Œè½¬å‘ã€‚</li>
<li><code>getAllPost</code> å‡½æ•°å¯ä»¥è·å–æ‰€æœ‰å¸–å­ï¼Œå¹¶æŒ‰åˆ›å»ºæ—¶é—´æ’åºã€‚</li>
</ul>
<p><code>FeedDirectory</code> ç±»åˆ™è´Ÿè´£ç®¡ç†ç”¨æˆ·çš„ä¿¡æ¯æµã€‚å®ƒä½¿ç”¨ <code>TrieMap</code> å­˜å‚¨å’Œæ£€ç´¢ç”¨æˆ·ä¿¡æ¯æµä¸­çš„å¸–å­ã€‚</p>
<p><strong>feed.mo æ–‡ä»¶</strong></p>
<p>Feed ä»£è¡¨äº†ç¤¾äº¤åª’ä½“å¹³å°ä¸­çš„ç”¨æˆ·ä¿¡æ¯æµã€‚å®ƒç”¨å‰é¢æ•°æ®åº“æ–‡ä»¶å®šä¹‰çš„ <code>PostDirectory</code> å’Œ <code>FeedDirectory</code> æ¥ç®¡ç†å¸–å­å’Œä¿¡æ¯æµã€‚</p>
<ul>
<li><code>Feed</code> ç±»ä¸­æœ‰å¤šä¸ªå‡½æ•°ï¼Œ<code>createPost</code>ã€<code>createRepost</code>ã€<code>createComment</code> å’Œ <code>createLike</code>ï¼Œå®ƒä»¬å®ç°äº†ç”¨æˆ·åœ¨ç¤¾äº¤åª’ä½“ä¸Šçš„åŸºæœ¬äº’åŠ¨ã€‚</li>
<li><code>receiveFeed</code> ã€<code>batchReceiveFeed</code> ã€<code>receiveComment</code> ã€<code>batchReceiveComment</code> ã€<code>receiveLike</code> å’Œ <code>batchReceiveLike</code> å‡½æ•°ç”¨äºæ¥æ”¶å…¶ä»–ç”¨æˆ·çš„å¸–å­ã€è¯„è®ºå’Œç‚¹èµï¼Œå¹¶å°†è¿™äº›æ´»åŠ¨åŠ å…¥åˆ°å½“å‰ç”¨æˆ·çš„ä¿¡æ¯æµä¸­ã€‚</li>
<li><code>getLatestFeed</code> å‡½æ•°å…è®¸ç”¨æˆ·æ£€ç´¢ä»–ä»¬ä¿¡æ¯æµä¸­çš„æœ€æ–°å¸–å­ã€‚</li>
</ul>
<br>
<h3 id="åˆ›å»ºfeedcanisterrootfeedmo"><a class="header" href="#åˆ›å»ºfeedcanisterrootfeedmo">åˆ›å»ºFeedCanisterï¼šrootFeed.mo</a></h3>
<p>ç®¡ç†ç”¨æˆ·çš„ Feed Canister ï¼š</p>
<ul>
<li>
<p>å®šä¹‰å­˜å‚¨ç”¨æˆ·å’Œå¯¹åº” Feed Canister çš„æ˜ å°„å…³ç³»çš„ TrieMap - <code>userFeedCanisterMap</code></p>
</li>
<li>
<p>æä¾›åˆ›å»ºç”¨æˆ·ä¸ªäºº Feed Canister çš„æ–¹æ³• - <code>createFeedCanister()</code></p>
</li>
<li>
<p>æä¾›ç”¨æˆ· Feed Canister çš„æ–¹æ³• - <code>getUserFeedCanister()</code></p>
</li>
<li>
<p>æä¾›è·å–æ‰€æœ‰ç”¨æˆ· Feed æ˜ å°„çš„æ–¹æ³• - <code>getAllUserFeedCanister()</code></p>
</li>
<li>
<p>æä¾›è·å–æ€»å…±åˆ›å»ºçš„ Feed Canister æ•°é‡çš„æ–¹æ³• - <code>getTotalUserFeedCanisterNumber()</code></p>
</li>
</ul>
<p>ç®¡ç† Feed ç³»ç»Ÿçš„å…¶ä»– Canister ï¼š</p>
<ul>
<li>
<p>å­˜å‚¨å’Œæä¾›æ¥å£æŸ¥è¯¢ / æ›´æ–° Post ã€Comment ã€Like çš„ Fetch Canister</p>
</li>
<li>
<p>åœ¨åˆ›å»ºç”¨æˆ· Feed æ—¶ï¼ŒåŒæ­¥æ›´æ–°è¿™äº› Fetch Canister ä¸­çš„æ˜ å°„å…³ç³»</p>
</li>
</ul>
<br>
<p>é¦–å…ˆä¾ç„¶æ˜¯å®šä¹‰ Feed ç³»ç»Ÿéœ€è¦çš„ä¸€äº›åŸºç¡€ç±»å‹å’Œæ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬ç”¨äºè·å– Feed çš„æ•°æ®çš„ Actor ï¼Œç”¨äºå­˜å‚¨æ˜ å°„å…³ç³»çš„ TrieMap ã€‚</p>
<pre><code class="language-js">// è‡ªå®šä¹‰çš„Actorç±»å‹ï¼Œç”¨äºè·å–Feedçš„ä¸åŒéƒ¨åˆ†çš„æ•°æ®
type RootFetchActor = Types.RootFetchActor;
type PostFetchActor = Types.PostFetchActor;
type CommentFetchActor = Types.CommentFetchActor;
type LikeFetchActor = Types.LikeFetchActor;

stable let T_CYCLES = 1_000_000_000_000; // 1ä¸‡äº¿ä¸ªcyclesï¼Œ1Tï¼Œæ–¹ä¾¿åç»­æ“ä½œ

// ä¸€ä¸ªå­˜å‚¨é”®å€¼å¯¹çš„æ•°ç»„ï¼Œé”®æ˜¯ç”¨æˆ·Principalï¼Œå€¼æ˜¯å¯¹åº”çš„ feed canister çš„Principal
stable var userFeedCanisterMapEntries: [(Principal, Principal)] = [];
// ä¸€ä¸ªä»ç”¨æˆ·Principalåˆ° feed canister Principal çš„TrieMap
// é€šè¿‡fromEntriesæ„é€ ï¼Œä¼ å…¥userFeedCanisterMapEntries
let userFeedCanisterMap = TrieMap.fromEntries&lt;Principal, Principal&gt;(userFeedCanisterMapEntries.vals(), Principal.equal, Principal.hash);
let ic: IC.Service = actor(&quot;aaaaa-aa&quot;);
</code></pre>
<p><code>TrieMap</code> æ˜¯ä¸€ç§é”®å€¼å­˜å‚¨ç»“æ„ï¼Œå®ƒå¯ä»¥é«˜æ•ˆåœ°æ’å…¥å’ŒæŸ¥æ‰¾æ•°æ®ã€‚</p>
<pre><code class="language-js">let postMap = TrieMap.fromEntries&lt;Nat, Post&gt;(postMapEntries.vals(), Nat.equal, Hash.hash);
</code></pre>
<p>è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª <code>TrieMap</code>ï¼Œå®ƒç”¨æ¥å­˜å‚¨å¸–å­æ•°æ®ï¼Œå…¶ä¸­ <code>Nat</code> æ˜¯é”®çš„ç±»å‹ï¼Œ<code>Post</code> æ˜¯å€¼çš„ç±»å‹ã€‚</p>
<br>
<p>ä¸ºç”¨æˆ·åˆ›å»ºè‡ªå·±çš„ Feed Canister çš„é€»è¾‘ï¼šç»™ç”¨æˆ·åˆ›å»ºè‡ªå·±çš„ Feed Canister ï¼Œå¹¶åšèº«ä»½éªŒè¯ã€æˆæƒè®¾ç½®ã€æ•°æ®æ˜ å°„å…³ç³»åŒæ­¥ç­‰å·¥ä½œã€‚</p>
<pre><code class="language-js">// ç»™ç”¨æˆ·åˆ›å»ºä¸€ä¸ªç”¨æˆ·è‡ªå·±çš„Canister
public shared({caller}) func createFeedCanister(): async ?Principal {
    // æ£€æŸ¥è°ƒç”¨è€…èº«ä»½
    assert(_getUserFeedCanister(caller) == null);
    // ç»™æ¯ä¸ªæ–°Canisteråˆ†é… 2T Cycles
    Cycles.add(2 * T_CYCLES);
    // è°ƒç”¨ `Feed.Feed` æ–¹æ³•åˆ›å»ºç”¨æˆ·çš„ Feed Canister
    let feedCanister = await Feed.Feed(
        caller, rootPostCanister, userCanister, 
        postFetchCanister,
        commentFetchCanister,
        likeFetchCanister
    );
    // è·å–Canisterçš„IDï¼Œå­˜å…¥æ˜ å°„TrieMapä¸­
    let feedCanisterId = Principal.fromActor(feedCanister);
    userFeedCanisterMap.put(caller, feedCanisterId);
    // è°ƒç”¨icæ–¹æ³•æ›´æ–°è¯¥Canisterçš„è®¾ç½®ï¼ŒæˆæƒRoot Canisterå’Œç”¨æˆ·è‡ªå·±ä½œä¸ºcontrollers
    await ic.update_settings({
        canister_id = feedCanisterId;
        settings = {
            freezing_threshold = null;
            controllers = ?[Principal.fromActor(this), feedCanisterId];
            memory_allocation = null;
            compute_allocation = null;
        }
    });
    
    // æ›´æ–°fetchä¸­çš„ä¿¡æ¯ï¼Œåœ¨ Post/Comment/Like Fetch Canister ä¸­ä¹Ÿæ›´æ–°è¯¥ç”¨æˆ·çš„æ˜ å°„å…³ç³»
    ignore updateFetchUserToFeed((caller, feedCanisterId));
    
    // è¿”å›æ–°åˆ›å»ºçš„ Feed Canister ID
    ?feedCanisterId
};
</code></pre>
<br>
<p>å½“æœ‰ç”¨æˆ· Feed Canister åˆ›å»ºæ—¶ï¼ŒåŒæ­¥åˆ°å…¶ä»–ä¾èµ–è¿™ä¸ªæ˜ å°„å…³ç³»çš„ Canister ï¼Œä¿è¯ Feed ç³»ç»Ÿçš„æ•°æ®ä¸€è‡´æ€§ã€‚</p>
<p>æ€»å…±åˆ† 3 æ­¥ï¼š</p>
<ol>
<li>ä» Root Fetch Canister è·å–æ‰€æœ‰ Post ã€Comment ã€Like Fetch Canister çš„ ID ã€‚</li>
<li>éå†æ¯ä¸ª Fetch Canister ï¼Œåˆ›å»º Actor å¼•ç”¨ã€‚</li>
<li>è°ƒç”¨æ¯ä¸ª Fetch Canister çš„ <code>addUserToFeedEntry</code> æ–¹æ³•ï¼Œä¼ å…¥ç”¨æˆ·å’Œå¯¹åº” Feed Canister çš„æ˜ å°„å…³ç³»ã€‚</li>
</ol>
<pre><code class="language-js">func updateFetchUserToFeed(entry: (Principal, Principal)): async () {
    let rootFetchActor: RootFetchActor = actor(Principal.toText(rootFetchCanister));

    // æ›´æ–° postFetch ä¸­çš„ä¿¡æ¯
    let postFetchCanisterArray = await rootFetchActor.getAllPostFetchCanister();
    for(_canister in postFetchCanisterArray.vals()) {
        let postFetchActor: PostFetchActor = actor(Principal.toText(_canister));
        ignore postFetchActor.addUserToFeedEntry(entry);
    };

    // æ›´æ–° commentFetch
    let commentFetchCanisterArray = await rootFetchActor.getAllCommentFetchCanister();
    for(_canister in commentFetchCanisterArray.vals()) {
        let commentFetchActor: CommentFetchActor = actor(Principal.toText(_canister));
        ignore commentFetchActor.addUserToFeedEntry(entry);
    };
    
    // æ›´æ–° likeFetch
    let likeFetchCanisterArray = await rootFetchActor.getAllLikeFetchCanister();
    for(_canister in likeFetchCanisterArray.vals()) {
        let likeFetchActor: LikeFetchActor = actor(Principal.toText(_canister));
        ignore likeFetchActor.addUserToFeedEntry(entry);
    };
};
</code></pre>
<br>
<p>è¿™å‡ ä¸ªå‡½æ•°æ˜¯ç”¨äºæŸ¥è¯¢ç”¨æˆ· Feed Canister æ˜ å°„å…³ç³»çš„ï¼š</p>
<p>æŒ‰ç”¨æˆ·æŸ¥è¯¢ã€è·å–å…¨éƒ¨æ˜ å°„ã€è·å–æ€»æ•°ç­‰ä¸åŒç²’åº¦çš„æ¥å£ï¼Œå¯ä»¥æŸ¥è¯¢ç”¨æˆ· Feed Canister çš„æ˜ å°„å…³ç³»ï¼Œç”¨äºè¯»å–å½“å‰çš„ Feed ç³»ç»Ÿå†…éƒ¨çŠ¶æ€ã€‚</p>
<pre><code class="language-js">// æ¥æ”¶ä¸€ä¸ªç”¨æˆ·Principalä½œä¸ºå‚æ•°
public query func getUserFeedCanister(user: Principal): async ?Principal {
    // è°ƒç”¨ç§æœ‰å‡½æ•°ï¼Œè¿”å›è¯¥ç”¨æˆ·å¯¹åº”çš„ Feed Canister Principal
    _getUserFeedCanister(user)
};

// return [(user, feedCanister)]
public query func getAllUserFeedCanister(): async [(Principal, Principal)] {
    // å°†å†…éƒ¨çš„userFeedCanisterMapè½¬æ¢æˆæ•°ç»„
    // è¿”å›æ‰€æœ‰ç”¨æˆ·åˆ°Feed Canisterçš„æ˜ å°„å…³ç³»æ•°ç»„
    Iter.toArray(userFeedCanisterMap.entries())
};

// æ€»å…±åˆ›å»ºäº†å¤šå°‘ä¸ªCanister
public query func getTotalUserFeedCanisterNumber(): async Nat {
    // è¿”å›userFeedCanisterMapçš„å¤§å°ï¼Œä¹Ÿå°±æ˜¯å…¨éƒ¨ Feed Canister çš„æ•°é‡
    userFeedCanisterMap.size()
};

// å†…éƒ¨ç§æœ‰æ–¹æ³•ï¼ŒæŸ¥è¯¢ç”¨æˆ·çš„Feed
private func _getUserFeedCanister(user: Principal): ?Principal {
    // æŸ¥è¯¢userFeedCanisterMap
    switch(userFeedCanisterMap.get(user)) {
        case(null) { return null;};
        // æ ¹æ®ç»™å®šç”¨æˆ·Principal,è¿”å›å¯¹åº”çš„ Feed Canister Id
        case(?canister) { return ?canister;};
    };
};
</code></pre>
<br>
<p>åœ¨åˆ›å»º Bucket æ—¶ï¼Œæˆ‘ä»¬è¿˜å¾—å‘Šè¯‰ Bucket ç³»ç»Ÿä¸­çš„ Post Fetch ã€Comment Fetch å’Œ Like Fetch çš„ Canister ID ï¼Œæ‰€ä»¥åœ¨ Root Post ä¸­ï¼Œæˆ‘ä»¬è¿˜è¦è®°å½•ã€ä¿å­˜ Post Fetch ã€Comment Fetch å’Œ Like Fetch ï¼š</p>
<pre><code class="language-js">stable var postFetchCanister = _postFetchCanister;

public query func getPostFetchCanister(): async Principal { postFetchCanister };

public shared({caller}) func updatePostFetchCanister(
    newPostFetchCanister: Principal
): async () {
    postFetchCanister := newPostFetchCanister;
};

// CommentFetchCanister

stable var commentFetchCanister = _commentFetchCanister;
    
public query func getCommentFetchCanister(): async Principal { commentFetchCanister };

public shared({caller}) func updateCommentFetchCanister(
    newCommentFetchCanister: Principal
): async () {
    commentFetchCanister := commentFetchCanister;
};

// LikeFetchCanister

stable var likeFetchCanister = _likeFetchCanister;
    
public query func getLikeFetchCanister(): async Principal { likeFetchCanister };

public shared({caller}) func updateLikeFetchCanister(
    newLikeFetchCanister: Principal
): async () {
    likeFetchCanister := newLikeFetchCanister;
};

system func preupgrade() {
    userFeedCanisterMapEntries := Iter.toArray(userFeedCanisterMap.entries());
};

system func postupgrade() {
    userFeedCanisterMapEntries := [];
};
</code></pre>
<p>æœ€åæ˜¯ä¸¤ä¸ªç³»ç»Ÿå‡½æ•° <code>preupgrade()</code> å’Œ <code>postupgrade()</code> ï¼Œç”¨æ¥åœ¨ Canister å‡çº§å‰åä¿å­˜æ•°æ®ã€‚</p>
<br>
<h3 id="å­˜å‚¨æ•°æ®databasemo"><a class="header" href="#å­˜å‚¨æ•°æ®databasemo">å­˜å‚¨æ•°æ®ï¼šdatabase.mo</a></h3>
<p>database.mo æ–‡ä»¶è´Ÿè´£å­˜å‚¨ç”¨æˆ·çš„ Feed Canister é‡Œçš„æ•°æ®ã€‚</p>
<p>é¦–å…ˆè¿˜æ˜¯å®šä¹‰å¸–å­ç´¢å¼•å’Œæ˜ å°„å…³ç³»çš„å­˜å‚¨ç»“æ„ï¼Œä»¥åŠç›¸å…³çš„æŸ¥è¯¢æ¥å£ã€‚</p>
<p>postIndex ç”¨äºç”Ÿæˆå¸–å­å”¯ä¸€ ID ï¼›postMap å­˜å‚¨å¸–å­æ•°æ®ã€‚getPostIndexEntries å’Œ getPostMapEntries ç”¨äºæŸ¥è¯¢å¸–å­çš„ç´¢å¼•èŒƒå›´å’Œæ˜ å°„å…³ç³»ã€‚</p>
<pre><code class="language-js">// å®šä¹‰ä¸€äº›ä¸å¸–å­ç›¸å…³çš„ç±»å‹åˆ«å
type Post = Types.Post;
type PostImmutable = Types.PostImmutable;
type Comment = Types.Comment;
type NewComment = Types.NewComment;
type UserId = Types.UserId;
type Time = Types.Time;
type Like = Types.Like;
type NewLike = Types.NewLike;
type Repost = Types.Repost;
type NewRepost = Types.NewRepost;

// ä¸€ä¸ªè‡ªå¢çš„å¸–å­ç´¢å¼•å€¼
var postIndex: Nat = postIndexEntries;
// ä¸€ä¸ªä»å¸–å­ç´¢å¼•åˆ°å¸–å­çš„æ˜ å°„è¡¨,ä½¿ç”¨TrieMapå®ç°
let postMap = TrieMap.fromEntries&lt;Nat, Post&gt;(postMapEntries.vals(), Nat.equal, Hash.hash); // postIndex -&gt; Post

// è¿”å›å½“å‰çš„æœ€å¤§å¸–å­ç´¢å¼•å€¼
public func getPostIndexEntries(): Nat { postIndex };

// è¿”å›postMapä¸­çš„å…¨éƒ¨æ˜ å°„å…³ç³»æ•°ç»„
public func getPostMapEntries(): [(Nat, Post)] { Iter.toArray(postMap.entries()) };

// ç”¨äºç”Ÿæˆå¸–å­çš„å”¯ä¸€idï¼Œæ ¼å¼ä¸º: bucket#user#index
private func _getPostId(bucket: Principal, user: Principal, index: Nat): Text {
    Principal.toText(bucket) # &quot;#&quot; # Principal.toText(user) # &quot;#&quot; # Nat.toText(index)
};
</code></pre>
<br>
<h4 id="å‘å¸–"><a class="header" href="#å‘å¸–">å‘å¸–</a></h4>
<p>åœ¨ Feed Canister ä¸­å‘å¸–çš„é€»è¾‘ï¼š</p>
<p>å®ç°å¯¹å¸–å­ä¿¡æ¯çš„æ„é€ ï¼Œå¹¶å­˜å‚¨åˆ°å¸–å­æ˜ å°„è¡¨ä¸­ã€‚</p>
<p>åŒæ—¶è¿”å›äº†ä¸€ä¸ªä¸å¯å˜çš„å¸–å­å¯¹è±¡ï¼Œé¿å…å¸–å­è¢«ä¿®æ”¹ã€‚</p>
<p>é€šè¿‡ postIndex çš„è‡ªå¢å¯ä»¥ä¿è¯æ¯ç¯‡å¸–å­æ‹¥æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ ID ã€‚</p>
<p>å¸–å­æ•°æ®è¢«å­˜å‚¨åœ¨ TrieMap ä¸­ï¼Œå¯ä»¥é«˜æ•ˆæŸ¥è¯¢ã€‚</p>
<pre><code class="language-js">// å‘å¸–
public func createPost(user: UserId, feedCanister: Principal, content: Text, time: Time, bucket: Principal): PostImmutable {
    let post: Post = {
        // ç”Ÿæˆå¸–å­çš„å”¯ä¸€id
        postId = _getPostId(bucket, user, postIndex);
        // æ„é€ ä¸€ä¸ªPostè®°å½•ï¼ŒåŒ…æ‹¬å¸–å­å†…å®¹ã€ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´ç­‰å­—æ®µ
        feedCanister = feedCanister;
        index = postIndex;
        user = user;
        content = content;
        var repost = [];
        var like = [];
        var comment = [];
        createdAt = time;
    };
    
    // å°†è¿™ä¸ªPostè®°å½•æ”¾å…¥postMapä¸­
    postMap.put(postIndex, post);
    // postIndexè‡ªå¢
    postIndex += 1;

    // è¿”å›PostImmutable
    Utils._convertPostToImmutable(post)
};
</code></pre>
<br>
<p>æä¾›å¤–éƒ¨æŸ¥è¯¢å¸–å­çš„åŸºç¡€æ¥å£ã€‚</p>
<p>å®ç°è·å–å¸–å­æ€»æ•°å’Œæ ¹æ® id è·å–å•ä¸ªå¸–å­çš„åŠŸèƒ½ã€‚</p>
<pre><code class="language-js">// è·å–å¸–å­æ€»æ•°
public func getPostNumber(): Nat {
    // ç›´æ¥è°ƒç”¨postMapçš„size()
    postMap.size()
};

// æ ¹æ®idè·å–å•ä¸ªå¸–å­
public func getPost(postId: Text): ?PostImmutable {
    // æ¥æ”¶å¸–å­idä½œä¸ºå‚æ•°ï¼Œé¦–å…ˆè°ƒç”¨checkPostId()æ ¡éªŒidæ ¼å¼
    let (bucket, user, index) = utils.checkPostId(postId);
    // ä»postMapä¸­æ ¹æ®ç´¢å¼•å–å‡ºå¸–å­è®°å½•post
    switch(postMap.get(index)) {
        // å¦‚æœä¸å­˜åœ¨ï¼Œè¿”å›null
        case(null) { return null; };
        // å¦‚æœå­˜åœ¨ï¼Œè¿”å›å¸–å­
        case(?post) {
            return ?{
                postId = post.postId;
                feedCanister = post.feedCanister;
                index = post.index;
                user = post.user;
                repost = post.repost;
                content = post.content;
                like = post.like;
                comment = post.comment;
                createdAt = post.createdAt;
            }
        };
    };
};
</code></pre>
<br>
<h4 id="è¯„è®º"><a class="header" href="#è¯„è®º">è¯„è®º</a></h4>
<p>è¿”å›åŒ…å« Bucket å’Œæ›´æ–°åçš„å¸–å­è¯„è®ºæ•°ç»„çš„å…ƒç»„ã€‚</p>
<p>æ‰€ä»¥è¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥å¸–å­æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±æ·»åŠ æ–°è¯„è®ºï¼Œå¹¶è¿”å›åŒ…å«å¸–å­æ‰€åœ¨æ¡¶å’Œæ›´æ–°åçš„å¸–å­ä¿¡æ¯çš„å…ƒç»„ã€‚</p>
<p>ä¸»è¦é€»è¾‘æ˜¯æ£€æŸ¥å‚æ•°ï¼Œè·å–åŸå¸–å­ä¿¡æ¯ï¼Œæ›´æ–°å¸–å­è¯„è®ºï¼Œè¿”å›æ›´æ–°åçš„å¸–å­è¯„è®ºã€‚</p>
<pre><code class="language-js">// è¯„è®º
public func createComment(commentUser: UserId, postId: Text, content: Text, createdAt: Time): ?(Principal, NewComment) {
    // æ£€æŸ¥å¸–å­IDæ˜¯å¦æœ‰æ•ˆï¼Œå¹¶è¿”å›å¸–å­æ‰€åœ¨çš„bucketã€ç”¨æˆ·å’Œå¸–å­åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•
    let (bucket, user, index) = utils.checkPostId(postId);
    // è·å–è¦è¯„è®ºçš„å¸–å­postï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›null
    switch(postMap.get(index)) {
        case(null) { return null;};
        case(?post) {
            // å¦‚æœå¸–å­å­˜åœ¨ï¼Œåˆ™å°†æ–°è¯„è®ºæ·»åŠ åˆ°å¸–å­çš„commentæ•°ç»„ä¸­
            // è¯„è®ºå†…å®¹åŒ…å«ç”¨æˆ·IDã€è¯„è®ºå†…å®¹å’Œæ—¶é—´
            post.comment := Array.append(post.comment, [{
            user = commentUser; // å‘è¡¨è¯„è®ºçš„ç”¨æˆ·ID
            content = content; // è¯„è®ºå†…å®¹
            createdAt = createdAt; // è¯„è®ºæ—¶é—´
        }]);
            ?(bucket, post.comment)
        };
    };
};
</code></pre>
<br>
<h4 id="ç‚¹èµ"><a class="header" href="#ç‚¹èµ">ç‚¹èµ</a></h4>
<p>å…¶å®å’Œå‰é¢çš„è¯„è®ºå·®ä¸å¤šã€‚éƒ½æ˜¯é€šè¿‡ <code>postMap.get(index)</code> å®ç°ã€‚</p>
<pre><code class="language-js">// ç‚¹èµ
public func createLike(likeUser: UserId, postId: Text, createdAt: Time): ?(Principal, NewLike) {
    let (bucket, user, index) = utils.checkPostId(postId);
    switch(postMap.get(index)) {
        case(null) { return null; };
        case(?post) {
            for(like in post.like.vals()) {
                // å·²ç»ç‚¹èµè¿‡
                if(like.user == likeUser) { return null;};
        };
        post.like := Array.append&lt;Like&gt;(post.like, [{
            user = likeUser;
            createdAt = createdAt;
        }]);
            ?(bucket, post.like)
        };
    }
};
</code></pre>
<br>
<h4 id="è½¬å‘"><a class="header" href="#è½¬å‘">è½¬å‘</a></h4>
<p>å’Œä¸Šé¢ä¸€æ ·ã€‚</p>
<pre><code class="language-js">// è½¬å‘
public func createRepost(repostUser: UserId, postId: Text, createdAt: Time): ?(Principal, NewRepost) {
    let (bucket, user, index) = utils.checkPostId(postId);
    switch(postMap.get(index)) {
        case(null) { return null; };
        case(?post) {
            for(repost in post.repost.vals()) {
                // å·²ç»è½¬å‘è¿‡
                if(repost.user == repostUser) { return null;};
            };
        post.repost := Array.append&lt;Repost&gt;(post.repost, [{
            user = repostUser;
            createdAt = createdAt;
        }]);
            ?(bucket, post.repost)
        };
    }
};
</code></pre>
<br>
<h4 id="æŸ¥è¯¢æ‰€æœ‰å¸–å­"><a class="header" href="#æŸ¥è¯¢æ‰€æœ‰å¸–å­">æŸ¥è¯¢æ‰€æœ‰å¸–å­</a></h4>
<p>å‡½æ•° <code>getAllPost</code>ï¼Œè¯¥å‡½æ•°ä»ä¸€ä¸ªæ˜ å°„ (<code>postMap</code>) ä¸­è·å–æ‰€æœ‰çš„å¸–å­ (<code>Post</code>)ï¼Œå°†å®ƒä»¬è½¬æ¢æˆä¸å¯å˜çš„å½¢å¼ (<code>PostImmutable</code>)ï¼Œå¹¶æŒ‰ç…§åˆ›å»ºæ—¶é—´è¿›è¡Œæ’åºã€‚æœ€åï¼Œè¿”å›æ’åºåçš„å¸–å­æ•°ç»„ã€‚</p>
<ul>
<li>
<p><strong><code>TrieMap.map</code>ï¼š</strong></p>
<p>ä½¿ç”¨ <code>TrieMap.map</code> å¯¹ <code>postMap</code> ä¸­çš„æ¯ä¸€å¯¹é”®å€¼è¿›è¡Œæ˜ å°„ï¼Œå°†å…¶è½¬æ¢ä¸ºä¸å¯å˜çš„ <code>PostImmutable</code> ç±»å‹ã€‚è¿™ä¸ªæ˜ å°„æ˜¯é€šè¿‡ <code>Nat</code> ç±»å‹çš„é”®æ¥æ‰§è¡Œçš„ï¼Œä½¿ç”¨ <code>Nat.equal</code> å’Œ <code>Hash.hash</code> æ¥å¤„ç†é”®çš„ç›¸ç­‰æ€§å’Œå“ˆå¸Œã€‚</p>
<pre><code class="language-motoko">TrieMap.map&lt;Nat, Post, PostImmutable&gt;(
    postMap, Nat.equal, Hash.hash,
    func (k: Nat, v1: Post): PostImmutable {
        Utils._convertPostToImmutable(v1)
    }
)
</code></pre>
</li>
<li>
<p><strong><code>.vals()</code>ï¼š</strong></p>
<p>è·å–æ˜ å°„çš„æ‰€æœ‰å€¼ï¼Œè¿”å›ä¸€ä¸ªåŒ…å«æ‰€æœ‰è½¬æ¢åçš„ <code>PostImmutable</code> çš„æ•°ç»„ã€‚</p>
<pre><code class="language-motoko">TrieMap.map&lt;Nat, Post, PostImmutable&gt;(...).vals()
</code></pre>
</li>
<li>
<p><strong><code>Iter.sort</code>ï¼š</strong></p>
<p>å¯¹å€¼æ•°ç»„è¿›è¡Œæ’åºï¼ŒæŒ‰ç…§å¸–å­çš„åˆ›å»ºæ—¶é—´ (<code>createdAt</code>) è¿›è¡Œæ¯”è¾ƒã€‚ä½¿ç”¨ <code>Order.Order</code> æ¥æŒ‡å®šæ’åºçš„é¡ºåºï¼Œå…¶ä¸­ <code>#less</code> è¡¨ç¤ºå‡åºï¼Œ<code>#greater</code> è¡¨ç¤ºé™åºï¼Œ<code>#equal</code> è¡¨ç¤ºç›¸ç­‰ã€‚</p>
<pre><code class="language-motoko">Iter.sort&lt;PostImmutable&gt;(
    TrieMap.map&lt;Nat, Post, PostImmutable&gt;(...).vals(),
    func (x: PostImmutable, y: PostImmutable): Order.Order {
        if(x.createdAt &gt; y.createdAt) return #less
        else if(x.createdAt &lt; y.createdAt) return #greater
        else return #equal
    }
)
</code></pre>
</li>
<li>
<p><strong><code>Iter.toArray</code>ï¼š</strong></p>
<p>å°†æ’åºåçš„å¸–å­æ•°ç»„è½¬æ¢ä¸ºä¸€ä¸ª Motoko æ•°ç»„ï¼Œæœ€ç»ˆä½œä¸ºå‡½æ•°çš„è¿”å›å€¼ã€‚</p>
<pre><code class="language-motoko">Iter.toArray(...)
</code></pre>
</li>
</ul>
<p>æ•´ä¸ªå‡½æ•°çš„ç›®çš„æ˜¯è·å–æ˜ å°„ä¸­çš„æ‰€æœ‰å¸–å­ï¼Œå°†å®ƒä»¬è½¬æ¢ä¸ºä¸å¯å˜çš„å½¢å¼ï¼Œå¹¶æŒ‰ç…§åˆ›å»ºæ—¶é—´æ’åºï¼Œæœ€åè¿”å›æ’åºåçš„å¸–å­æ•°ç»„ã€‚</p>
<pre><code class="language-js">public func getAllPost(): [PostImmutable] {
    Iter.toArray(
        Iter.sort&lt;PostImmutable&gt;(
            TrieMap.map&lt;Nat, Post, PostImmutable&gt;(
                postMap, Nat.equal, Hash.hash,
                func (k: Nat, v1: Post): PostImmutable {
                Utils._convertPostToImmutable(v1)
            }
        ).vals(),
        func (x: PostImmutable, y: PostImmutable): Order.Order {
              if(x.createdAt &gt; y.createdAt) return #less
              else if(x.createdAt &lt; y.createdAt) return #greater
              else return #equal
        }))
    };

};
</code></pre>
<br>
<h4 id="feeddirectory-ç±»"><a class="header" href="#feeddirectory-ç±»">FeedDirectory ç±»</a></h4>
<p>åºŸè¯ä¸ç”¨å¤šè¯´ï¼Œç›´æ¥çœ‹ä»£ç ï¼š</p>
<pre><code class="language-js">public class FeedDirectory(
    feedMapEntries: [(Text, PostImmutable)]
) {
    
    type PostImmutable = Types.PostImmutable;

    // ä½¿ç”¨TrieMapç±»å‹åˆ›å»ºäº†ä¸€ä¸ªæ˜ å°„ï¼Œé”®æ˜¯Textç±»å‹ï¼Œå€¼æ˜¯PostImmutableç±»å‹
    // ç”¨äºå­˜å‚¨å¸–å­æ•°æ®
    let feedMap = TrieMap.fromEntries&lt;Text, PostImmutable&gt;(feedMapEntries.vals(), Text.equal, Text.hash);

    // è¿”å›åŒ…å«æ‰€æœ‰æ˜ å°„é¡¹çš„æ•°ç»„
    public func getFeedMapEntries(): [(Text, PostImmutable)] { Iter.toArray(feedMap.entries()) };

    // å°†å¸–å­æ·»åŠ åˆ°æ˜ å°„ä¸­ï¼Œé”®æ˜¯å¸–å­çš„postId
    public func storeFeed(post: PostImmutable) {
        feedMap.put(post.postId, post);
    };

    // æ‰¹é‡å°†å¸–å­æ•°ç»„ä¸­çš„æ‰€æœ‰å¸–å­æ·»åŠ åˆ°æ˜ å°„ä¸­
    public func batchStoreFeed(postArray: [PostImmutable]) {
        for(_post in postArray.vals()) {
            feedMap.put(_post.postId, _post);
        };
    };

    // è¿”å›æ˜ å°„ä¸­å­˜å‚¨çš„å¸–å­æ•°é‡
    public func getFeedNumber(): Nat {
        feedMap.size()
    };

    // æ ¹æ®ç»™å®šçš„postIdè¿”å›ç›¸åº”çš„å¸–å­
    // å¦‚æœå¸–å­ä¸å­˜åœ¨ï¼Œè¿”å›null
    public func getFeed(postId: Text): ?PostImmutable {
        switch(feedMap.get(postId)) {
            case(null) { return null; };
            case(?_feed) { return ?_feed; };
        };
    };

    // è¿”å›æœ€æ–°çš„nä¸ªå¸–å­ï¼ŒæŒ‰ç…§åˆ›å»ºæ—¶é—´æ’åº
    public func getLatestFeed(n: Nat): [PostImmutable] {
        let feedArray = Iter.toArray(
            Iter.sort&lt;PostImmutable&gt;(
            feedMap.vals(),
            func (x: PostImmutable, y: PostImmutable): Order.Order {
                if(x.createdAt &gt; y.createdAt) return #less
                else if(x.createdAt &lt; y.createdAt) return #greater
                else return #equal
        }));
        // å¦‚æœè¯·æ±‚çš„æ•°é‡è¶…è¿‡å®é™…å¸–å­æ•°é‡ï¼Œè¿”å›æ‰€æœ‰å¸–å­
        if(n &lt;= feedArray.size()) {
            Array.subArray(feedArray, 0, n)
        } else {
            Array.subArray(feedArray, 0, feedArray.size())
        }
    };

};
</code></pre>
<br>
<p>database.mo å®Œæ•´æ–‡ä»¶ï¼š</p>
<pre><code class="language-js">import Array &quot;mo:base/Array&quot;;
import HashMap &quot;mo:base/HashMap&quot;;
import Iter &quot;mo:base/Iter&quot;;
import Option &quot;mo:base/Option&quot;;
import Principal &quot;mo:base/Principal&quot;;
import Types &quot;./types&quot;;
import TrieMap &quot;mo:base/TrieMap&quot;;
import TrieSet &quot;mo:base/TrieSet&quot;;
import Hash &quot;mo:base/Hash&quot;;
import Nat &quot;mo:base/Nat&quot;;
import Time &quot;mo:base/Time&quot;;
import utils &quot;../utils&quot;;
import Text &quot;mo:base/Text&quot;;
import Order &quot;mo:base/Order&quot;;
import Utils &quot;../utils&quot;;

module {
  type Post = Types.Post;
  public class PostDirectory(
    postIndexEntries: Nat,
    postMapEntries: [(Nat, Post)]
  ) {

    type Post = Types.Post;
    type PostImmutable = Types.PostImmutable;
    type Comment = Types.Comment;
    type NewComment = Types.NewComment;
    type UserId = Types.UserId;
    type Time = Types.Time;
    type Like = Types.Like;
    type NewLike = Types.NewLike;
    type Repost = Types.Repost;
    type NewRepost = Types.NewRepost;

    var postIndex: Nat = postIndexEntries;
    let postMap = TrieMap.fromEntries&lt;Nat, Post&gt;(postMapEntries.vals(), Nat.equal, Hash.hash); // postIndex -&gt; Post

    public func getPostIndexEntries(): Nat { postIndex };

    public func getPostMapEntries(): [(Nat, Post)] { Iter.toArray(postMap.entries()) };

    private func _getPostId(bucket: Principal, user: Principal, index: Nat): Text {
      Principal.toText(bucket) # &quot;#&quot; # Principal.toText(user) # &quot;#&quot; # Nat.toText(index)
    };

    // å‘å¸–
    public func createPost(user: UserId, feedCanister: Principal, content: Text, time: Time, bucket: Principal): PostImmutable {
      let post: Post = {
        postId = _getPostId(bucket, user, postIndex);
        feedCanister = feedCanister;
        index = postIndex;
        user = user;
        content = content;
        var repost = [];
        var like = [];
        var comment = [];
        createdAt = time;
      };

      postMap.put(postIndex, post);
      postIndex += 1;

      Utils._convertPostToImmutable(post)
    };

    public func getPostNumber(): Nat {
      postMap.size()
    };

    public func getPost(postId: Text): ?PostImmutable {
      let (bucket, user, index) = utils.checkPostId(postId);
      switch(postMap.get(index)) {
        case(null) { return null; };
        case(?post) {
          return ?{
            postId = post.postId;
            feedCanister = post.feedCanister;
            index = post.index;
            user = post.user;
            repost = post.repost;
            content = post.content;
            like = post.like;
            comment = post.comment;
            createdAt = post.createdAt;
          }
        };
      };
    };

    // è¯„è®º
    public func createComment(commentUser: UserId, postId: Text, content: Text, createdAt: Time): ?(Principal, NewComment) {
      let (bucket, user, index) = utils.checkPostId(postId);
      switch(postMap.get(index)) {
        case(null) { return null;};
        case(?post) {
          post.comment := Array.append(post.comment, [{
            user = commentUser;
            content = content;
            createdAt = createdAt;
          }]);
          ?(bucket, post.comment)
        };
      };
    };

    // ç‚¹èµ
    public func createLike(likeUser: UserId, postId: Text, createdAt: Time): ?(Principal, NewLike) {
      let (bucket, user, index) = utils.checkPostId(postId);
      switch(postMap.get(index)) {
        case(null) { return null; };
        case(?post) {
          for(like in post.like.vals()) {
            // å·²ç»ç‚¹èµè¿‡
            if(like.user == likeUser) { return null;};
          };
          post.like := Array.append&lt;Like&gt;(post.like, [{
            user = likeUser;
            createdAt = createdAt;
          }]);
          ?(bucket, post.like)
        };
      }
    };

    // è½¬å‘
    public func createRepost(repostUser: UserId, postId: Text, createdAt: Time): ?(Principal, NewRepost) {
      let (bucket, user, index) = utils.checkPostId(postId);
      switch(postMap.get(index)) {
        case(null) { return null; };
        case(?post) {
          for(repost in post.repost.vals()) {
            // å·²ç»è½¬å‘è¿‡
            if(repost.user == repostUser) { return null;};
          };
          post.repost := Array.append&lt;Repost&gt;(post.repost, [{
            user = repostUser;
            createdAt = createdAt;
          }]);
          ?(bucket, post.repost)
        };
      }
    };

    public func getAllPost(): [PostImmutable] {
      Iter.toArray(
        Iter.sort&lt;PostImmutable&gt;(
          TrieMap.map&lt;Nat, Post, PostImmutable&gt;(
            postMap, Nat.equal, Hash.hash,
            func (k: Nat, v1: Post): PostImmutable {
              Utils._convertPostToImmutable(v1)
            }
          ).vals(),
          func (x: PostImmutable, y: PostImmutable): Order.Order {
              if(x.createdAt &gt; y.createdAt) return #less
              else if(x.createdAt &lt; y.createdAt) return #greater
              else return #equal
          }))
    };

  };
  
  type PostImmutable = Types.PostImmutable;

  public class FeedDirectory(
    feedMapEntries: [(Text, PostImmutable)]
  ) {
    
    type PostImmutable = Types.PostImmutable;

    let feedMap = TrieMap.fromEntries&lt;Text, PostImmutable&gt;(feedMapEntries.vals(), Text.equal, Text.hash);

    public func getFeedMapEntries(): [(Text, PostImmutable)] { Iter.toArray(feedMap.entries()) };

    public func storeFeed(post: PostImmutable) {
      feedMap.put(post.postId, post);
    };

    public func batchStoreFeed(postArray: [PostImmutable]) {
      for(_post in postArray.vals()) {
        feedMap.put(_post.postId, _post);
      };
    };

    public func getFeedNumber(): Nat {
      feedMap.size()
    };

    public func getFeed(postId: Text): ?PostImmutable {
      switch(feedMap.get(postId)) {
        case(null) { return null; };
        case(?_feed) { return ?_feed; };
      };
    };

    public func getLatestFeed(n: Nat): [PostImmutable] {
      let feedArray = Iter.toArray(
        Iter.sort&lt;PostImmutable&gt;(
        feedMap.vals(),
        func (x: PostImmutable, y: PostImmutable): Order.Order {
            if(x.createdAt &gt; y.createdAt) return #less
            else if(x.createdAt &lt; y.createdAt) return #greater
            else return #equal
      }));
      if(n &lt;= feedArray.size()) {
        Array.subArray(feedArray, 0, n)
      } else {
        Array.subArray(feedArray, 0, feedArray.size())
      }
    };

  };
};
</code></pre>
<br>
<h3 id="ç”¨æˆ·äº‘ç»ˆç«¯feedmo"><a class="header" href="#ç”¨æˆ·äº‘ç»ˆç«¯feedmo">ç”¨æˆ·äº‘ç»ˆç«¯ï¼šfeed.mo</a></h3>
<br>
<h4 id="owner"><a class="header" href="#owner">owner</a></h4>
<p>Feed Canister é‡Œéœ€è¦å­˜å‚¨ owner æ˜¯è°ï¼Œä»¥åŠåæœŸå¯ä»¥è½¬ç§»è‡ªå·±çš„æ§åˆ¶æƒã€‚</p>
<pre><code class="language-js">stable var owner = _owner;

// æŸ¥è¯¢ownerï¼Œå…è®¸åˆçº¦çš„ç”¨æˆ·å¼‚æ­¥åœ°è·å–å½“å‰çš„owner
// ç”±äºæ˜¯æŸ¥è¯¢å‡½æ•°ï¼Œå®ƒä¸ä¿®æ”¹åˆçº¦çŠ¶æ€ï¼Œå› æ­¤å¯ä»¥è¢«ä»»ä½•ç”¨æˆ·è°ƒç”¨è€Œä¸éœ€è¦ç»è¿‡å…±è¯†
public query func getOwner(): async Principal { owner };

// æ›´æ–°owner
public shared({caller}) func updateOwner(newOwner: Principal): async () {
    assert(caller == owner);
    owner := newOwner;
};

public query({caller}) func whoami(): async Principal { caller };
</code></pre>
<br>
<h4 id="fetchcanister"><a class="header" href="#fetchcanister">FetchCanister</a></h4>
<p>åŒæ ·ï¼ŒFeed Canister é‡Œè¿˜éœ€è¦è®°å½•å„ç§ Fetch Canister ã€‚</p>
<pre><code class="language-js">stable var postFetchCanister = _postFetchCanister;

public query func getPostFetchCanister(): async Principal { postFetchCanister };

public shared({caller}) func updatePostFetchCanister(
    newPostFetchCanister: Principal
): async () {
    postFetchCanister := newPostFetchCanister;
};
</code></pre>
<p>CommentFetchCanister ï¼š</p>
<pre><code class="language-js">stable var commentFetchCanister = _commentFetchCanister;

public query func getCommentFetchCanister(): async Principal { commentFetchCanister };

public shared({caller}) func updateCommentFetchCanister(
    newCommentFetchCanister: Principal
): async () {
    commentFetchCanister := commentFetchCanister;
};
</code></pre>
<p>LikeFetchCanister ï¼š</p>
<pre><code class="language-js">stable var likeFetchCanister = _likeFetchCanister;

public query func getLikeFetchCanister(): async Principal { likeFetchCanister };

public shared({caller}) func updateLikeFetchCanister(
    newLikeFetchCanister: Principal
): async () {
    likeFetchCanister := newLikeFetchCanister;
};
</code></pre>
<br>
<h4 id="followers"><a class="header" href="#followers">Followers</a></h4>
<p>Feed Canister é‡ŒåŒæ ·ç»´æŠ¤ç€ä¸€ä¸ªç²‰ä¸åˆ—è¡¨ã€‚åœ¨ç”¨æˆ·å‘å¸–æ—¶ï¼ŒFeed Canister ä¼šæŠŠå¸–å­ ID å’Œç²‰ä¸å‘ç»™ Fetch Canister ï¼Œå‘Šè¯‰ Fetch åº”è¯¥é€šçŸ¥å“ªäº›äººã€‚</p>
<p>åœ¨ç´§æ€¥æƒ…å†µä¸‹ï¼Œå¯ä»¥ç›´æ¥ç‚¹å¯¹ç‚¹å‘ç²‰ä¸å‘é€å¸–å­ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ç‚¹å¯¹ç‚¹ç•™è¨€ã€‚</p>
<pre><code class="language-js">stable var followers: [Principal] = [];

// æ¥æ”¶ user canister çš„æ›´æ–°
public shared({caller}) func updateFollowers(newFollowers: [Principal]): async () {
    followers := newFollowers;
};

public query func getFollowers(): async [Principal] {
    followers
};
</code></pre>
<br>
<h4 id="bucket"><a class="header" href="#bucket">Bucket</a></h4>
<pre><code class="language-js">type RootPostActor = Types.RootPostActor;
stable var bucket: ?Principal = null;
stable let rootPostActor: RootPostActor = actor(Principal.toText(rootPostCanister));

// æ›´æ–°å½“å‰feedå»å­˜å‚¨çš„bucket canister
public shared func checkAvailableBucket(): async Bool {
    switch((await rootPostActor.getAvailableBucket())) {
        case(null) { return false; };
        case(?_bucket) {
            bucket := ?_bucket;
            return true;
        };
    };
};

public query func getbucket(): async ?Principal { bucket };
</code></pre>
<br>
<h4 id="post"><a class="header" href="#post">Post</a></h4>
<p>ç„¶åæ˜¯å’Œå¸–å­æœ‰å…³çš„åŠŸèƒ½ã€‚</p>
<pre><code class="language-js">type Time = Types.Time;
type UserId = Types.UserId;
type BucketActor = Types.BucketActor;
type PostFetchActor = Types.PostFetchActor;
type Post = Types.Post;

stable var postIndexEntries: Nat = 0;
stable var postMapEntries: [(Nat, Post)] = [];
let postDirectory: Database.PostDirectory = Database.PostDirectory(postIndexEntries, postMapEntries);

// æŸ¥è¯¢ç”¨æˆ·å‘äº†å¤šå°‘å¸–å­ï¼ˆç»Ÿè®¡æ€»æ•°ï¼‰
public query func getPostNumber(): async Nat {
    postDirectory.getPostNumber()
};

// æ ¹æ®å¸–å­IDæŸ¥è¯¢ç”¨æˆ·å‘çš„æŸä¸ªå¸–å­
public query func getPost(postId: Text): async  ?PostImmutable {
    postDirectory.getPost(postId)
};

// æŸ¥è¯¢æ‰€æœ‰å¸–å­
public query func getAllPost(): async [PostImmutable] {
    postDirectory.getAllPost()
};
</code></pre>
<br>
<p>ç”¨æˆ·å‘å¸–çš„æ ¸å¿ƒé€»è¾‘ã€‚</p>
<pre><code class="language-js">public shared({caller}) func createPost(title: Text, content: Text): async Text {
    // æ£€æŸ¥æ˜¯å¦ç”±ä¿¡æ¯æµçš„æ‰€æœ‰è€…è°ƒç”¨ï¼Œç¡®ä¿bucketï¼ˆç”¨äºå­˜å‚¨å¸–å­çš„åœ°æ–¹ï¼‰æ˜¯å­˜åœ¨çš„
    assert(caller == owner and bucket != null);
    let _bucket = Option.unwrap(bucket);
    // åˆ›å»ºä¸€ä¸ªæ–°å¸–å­
    let post: PostImmutable = postDirectory.createPost(caller, Principal.fromActor(this), content, Time.now(), _bucket);

    // å°†å¸–å­å†…å®¹å‘é€ç»™å…¬å…±åŒºçš„Bucket 
    let bucketActor: BucketActor = actor(Principal.toText(_bucket));
    assert(await bucketActor.storeFeed(post));

    // é€šçŸ¥PostFetchæœ‰æ–°å¸–å­å‘å¸ƒ
    let postFetchActor: PostFetchActor = actor(Principal.toText(postFetchCanister));
    await postFetchActor.receiveNotify(followers, post.postId);

    post.postId
};
</code></pre>
<br>
<p>åˆ›å»ºè½¬å‘ã€‚</p>
<pre><code class="language-js">public shared({caller}) func createRepost(postId: Text): async Bool {
    switch(postDirectory.createRepost(caller, postId, Time.now())) {
        case(null) { return false; };
        case(?(_bucket, _newRepost)) {
            // é€šçŸ¥bucketæ›´æ–°è½¬å‘ä¿¡æ¯
            let bucketActor: BucketActor = actor(Principal.toText(_bucket));
            assert(await bucketActor.updatePostRepost(postId, _newRepost));

            // è·å–è½¬å‘è€…çš„ç²‰ä¸
            let userActor: UserActor = actor(Principal.toText(userCanister));
            let _repostUserFollowers = await userActor.getFollowersList(caller);

            // é€šçŸ¥PostFetch
            let postFetchActor: PostFetchActor = actor(Principal.toText(postFetchCanister));
            await postFetchActor.receiveNotify(_repostUserFollowers, postId);
            return true;
        };
    };
};
</code></pre>
<br>
<p>è¯„è®ºä¸ç‚¹èµã€‚</p>
<p>æˆ‘ä»¬ä½¿ç”¨ <code>postDirectory</code> å¯¹è±¡æ¥åˆ›å»ºè¯„è®ºæˆ–ç‚¹èµã€‚</p>
<pre><code class="language-js">// å…±äº«å‡½æ•°ï¼Œéœ€è¦æä¾›è°ƒç”¨è€…çš„ä¿¡æ¯ï¼ˆcallerï¼‰
public shared({caller}) func createComment(postId: Text, content: Text): async Bool {
    // æ ¹æ®postDirectory.createCommentçš„è¿”å›å€¼è¿›è¡ŒåŒ¹é…å¤„ç†
    switch(postDirectory.createComment(caller, postId, content, Time.now())) {
        // åˆ›å»ºå¤±è´¥
        case(null) { return false; };
        // å¦‚æœè¿”å›ä¸€ä¸ªåŒ…å«_bucketå’Œ_newCommentçš„å…ƒç»„ï¼Œè¡¨ç¤ºæˆåŠŸåˆ›å»ºè¯„è®ºï¼Œè¿›è¡Œä»¥ä¸‹å¤„ç†
        case(?(_bucket, _newComment)) {
            // é€šçŸ¥å¯¹åº”çš„bucketæ›´æ–°è¯„è®º
            let bucketActor: BucketActor = actor(Principal.toText(_bucket));
            // assertå…³é”®å­—ç”¨äºç¡®ä¿æ›´æ–°æ“ä½œæˆåŠŸ
            assert(await bucketActor.updatePostComment(postId, _newComment));
            return true;
        };
    };
};

public shared({caller}) func createLike(postId: Text): async Bool {
    switch(postDirectory.createLike(caller, postId, Time.now())) {
        case(null) { return false; };
        case(?(_bucket, _newLike)) {
            // é€šçŸ¥bucketæ›´æ–°ç‚¹èµä¿¡æ¯
            let bucketActor: BucketActor = actor(Principal.toText(_bucket));
            assert(await bucketActor.updatePostLike(postId, _newLike));
            return true;
        };
    };
};
</code></pre>
<br>
<h4 id="feed-1"><a class="header" href="#feed-1">Feed</a></h4>
<p>å®šä¹‰ä¸€äº›ç±»å‹åˆ«åå’Œå˜é‡ã€‚</p>
<pre><code class="language-js">type PostImmutable = Types.PostImmutable;
type FeedActor = Types.FeedActor;
type UserActor = Types.UserActor;
type CommentFetchActor = Types.CommentFetchActor;
type LikeFetchActor = Types.LikeFetchActor;

stable var feedMapEntries: [(Text, PostImmutable)] = [];
let feedDirectory = Database.FeedDirectory(feedMapEntries);
</code></pre>
<br>
<p>é™¤äº† Feed å‘å¸ƒå¸–å­ã€è¯„è®ºã€ç‚¹èµä»¥å¤–ï¼ŒFeed è¿˜éœ€è¦æ¥æ”¶å…¶ä»– Fetchçš„é€šçŸ¥ï¼Œæ›´æ–° Feed å†…éƒ¨çš„ä¿¡æ¯æµã€‚</p>
<pre><code class="language-js">public shared({caller}) func receiveFeed(postId: Text): async Bool {
    let (_bucket, _, _) = Utils.checkPostId(postId);
    let bucketActor: BucketActor = actor(Principal.toText(_bucket));
    switch((await bucketActor.getPost(postId))) {
        case(null) { return false; };
        case(?_post) {
            feedDirectory.storeFeed(_post);
            return true;
        };
    };
};
</code></pre>
<br>
<p>æœ‰æ—¶å€™ Feed å¾—ä¸€æ¬¡æ€§æ¥æ”¶å¾ˆå¤šä¸ªå¸–å­ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªæ‰¹é‡æ¥æ”¶å¸–å­å‡½æ•°ã€‚</p>
<p>æ¥æ”¶ä¸€ä¸ªåŒ…å«å¤šä¸ªå¸–å­ ID çš„æ•°ç»„ï¼Œé’ˆå¯¹æ¯ä¸ªå¸–å­ ID ä»ç›¸åº”çš„ Bucket ä¸­è·å–å¸–å­ä¿¡æ¯ï¼Œå¦‚æœå¸–å­å­˜åœ¨ï¼Œåˆ™å°†å…¶å­˜å‚¨åˆ° <code>feedDirectory</code> ä¸­ã€‚</p>
<pre><code class="language-js">public shared({caller}) func batchReceiveFeed(postIdArray: [Text]): async () {
    for(_postId in postIdArray.vals()) {
        let (_bucket, _, _) = Utils.checkPostId(_postId);
        let bucketActor: BucketActor = actor(Principal.toText(_bucket));
        switch((await bucketActor.getPost(_postId))) {
            case(null) { };
            case(?_post) {
                feedDirectory.storeFeed(_post);
            };
        };
    };
};
</code></pre>
<br>
<p>æ¥æ”¶è¯„è®ºï¼Œå¹¶æ ¹æ®å¸–å­çš„è½¬å‘ä¿¡æ¯é€šçŸ¥ç›¸åº”çš„ç”¨æˆ·ç²‰ä¸ã€‚å¦‚æœå¸–å­ä¸å­˜åœ¨ï¼Œå‡½æ•°è¿”å› <code>false</code> ã€‚</p>
<pre><code class="language-js">public shared({caller}) func receiveComment(postId: Text): async Bool {
    let (_bucket, _, _) = Utils.checkPostId(postId);
    let bucketActor: BucketActor = actor(Principal.toText(_bucket));
    switch((await bucketActor.getPost(postId))) {
        case(null) { return false; };
        case(?_post) {

            feedDirectory.storeFeed(_post);

            if(Utils._isRepostUser(_post, owner)) {
                // å¦‚æœè¯¥ç”¨æˆ·æ˜¯æ­¤è´´çš„è½¬å‘è€…ï¼Œåˆ™ç»§ç»­å‘è‡ªå·±çš„ç²‰ä¸æ¨æµ                    
                let userActor: UserActor = actor(Principal.toText(userCanister));
                let repostUserFollowers = await userActor.getFollowersList(owner);

                let commentFetchActor: CommentFetchActor = actor(Principal.toText(commentFetchCanister));
                await commentFetchActor.receiveRepostUserNotify(repostUserFollowers, postId);
            };

            return true;
        };
    };
};
</code></pre>
<br>
<p>æ‰¹é‡æ¥æ”¶è¯„è®ºã€‚</p>
<pre><code class="language-js">public shared({caller}) func batchReceiveComment(postIdArray: [Text]): async () {
    for(_postId in postIdArray.vals()) {
        let (_bucket, _, _) = Utils.checkPostId(_postId);
        let bucketActor: BucketActor = actor(Principal.toText(_bucket));
        switch((await bucketActor.getPost(_postId))) {
            case(null) { };
            case(?_post) {
                // Debug.print(&quot;Canister Feed, Func batchReceiveComment&quot;);
                feedDirectory.storeFeed(_post);

                if(Utils._isRepostUser(_post, owner)) {
                    // å¦‚æœè¯¥ç”¨æˆ·æ˜¯æ­¤è´´çš„è½¬å‘è€…ï¼Œåˆ™ç»§ç»­å‘è‡ªå·±çš„ç²‰ä¸æ¨æµ                
                    let userActor: UserActor = actor(Principal.toText(userCanister));
                    let repostUserFollowers = await userActor.getFollowersList(owner);

                    let commentFetchActor: CommentFetchActor = actor(Principal.toText(commentFetchCanister));
                    await commentFetchActor.receiveRepostUserNotify(repostUserFollowers, _postId);
                };
            };
        };
    };
};
</code></pre>
<br>
<p>æ¥æ”¶ç‚¹èµã€‚</p>
<pre><code class="language-js">public shared({caller}) func receiveLike(postId: Text): async Bool {
    let (_bucket, _, _) = Utils.checkPostId(postId);
    let bucketActor: BucketActor = actor(Principal.toText(_bucket));
    switch((await bucketActor.getPost(postId))) {
        case(null) { return false; };
        case(?_post) {

            feedDirectory.storeFeed(_post);

            if(Utils._isRepostUser(_post, owner)) {
                // å¦‚æœè¯¥ç”¨æˆ·æ˜¯æ­¤è´´çš„è½¬å‘è€…ï¼Œåˆ™ç»§ç»­å‘è‡ªå·±çš„ç²‰ä¸æ¨æµ                    
                let userActor: UserActor = actor(Principal.toText(userCanister));
                let repostUserFollowers = await userActor.getFollowersList(owner);

                let likeFetchActor: LikeFetchActor = actor(Principal.toText(likeFetchCanister));
                await likeFetchActor.receiveRepostUserNotify(repostUserFollowers, postId);
            };

            return true;
        };
    };
};
</code></pre>
<br>
<p>æ‰¹é‡æ¥æ”¶ç‚¹èµã€‚</p>
<pre><code class="language-js">public shared({caller}) func batchReceiveLike(postIdArray: [Text]): async () {
    for(_postId in postIdArray.vals()) {
        let (_bucket, _, _) = Utils.checkPostId(_postId);
        let bucketActor: BucketActor = actor(Principal.toText(_bucket));
        switch((await bucketActor.getPost(_postId))) {
            case(null) {};
            case(?_post) {

                feedDirectory.storeFeed(_post);

                if(Utils._isRepostUser(_post, owner)) {
                    // å¦‚æœè¯¥ç”¨æˆ·æ˜¯æ­¤è´´çš„è½¬å‘è€…ï¼Œåˆ™ç»§ç»­å‘è‡ªå·±çš„ç²‰ä¸æ¨æµ                    
                    let userActor: UserActor = actor(Principal.toText(userCanister));
                    let repostUserFollowers = await userActor.getFollowersList(owner);

                    let likeFetchActor: LikeFetchActor = actor(Principal.toText(likeFetchCanister));
                    await likeFetchActor.receiveRepostUserNotify(repostUserFollowers, _postId);
                };
            };
        };
    };
};
</code></pre>
<br>
<p>æœ€åæ˜¯ä¸€äº›æŸ¥è¯¢å‡½æ•°ã€‚</p>
<pre><code class="language-js">public query func getFeedNumber(): async Nat {
    feedDirectory.getFeedNumber()
};

public query func getFeed(postId: Text): async ?PostImmutable {
    feedDirectory.getFeed(postId)
};

public query func getLatestFeed(n: Nat): async [PostImmutable] {
    feedDirectory.getLatestFeed(n)
};
</code></pre>
<br>
<p><a href="https://github.com/NeutronStarDAO/Proton/blob/rust/src/feed/feed.mo">è¿™é‡Œ</a>å¯ä»¥æŸ¥çœ‹ feed.mo çš„å®Œæ•´æ–‡ä»¶ã€‚</p>
<br>

                        <div id="giscus-container"></div>
                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../9.Dappå¼€å‘/5.Postæ¨¡å—.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../9.Dappå¼€å‘/7.Fetchæ¨¡å—.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../9.Dappå¼€å‘/5.Postæ¨¡å—.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../9.Dappå¼€å‘/7.Fetchæ¨¡å—.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>



        <script type="text/javascript">
            window.playground_line_numbers = true;
        </script>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>

        <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
        <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
        <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>
        <script type="text/javascript" charset="utf-8">
        var pagePath = "9.Dappå¼€å‘/6.Feedæ¨¡å—.md"
        </script>


        <!-- Custom JS scripts -->
        <script type="text/javascript" src="../assets/custom.js"></script>
        <script type="text/javascript" src="../assets/bigPicture.js"></script>


    </body>
</html>